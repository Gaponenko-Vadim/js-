import { PrismaClient } from '@prisma/client';
import { PrismaPg } from '@prisma/adapter-pg';
import { Pool } from 'pg';
import dotenv from 'dotenv';

dotenv.config();

const pool = new Pool({ connectionString: process.env.DATABASE_URL });
const adapter = new PrismaPg(pool);
const prisma = new PrismaClient({ adapter });

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –æ—Ç –ø—Ä–æ–±–ª–µ–º–Ω—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤
function cleanContent(content: string): string {
  return content
    .replace(/\0/g, '')
    .replace(/[\x00-\x08\x0B\x0C\x0E-\x1F]/g, '');
}

const lectureContentRaw = `# –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å HTTP –º–µ—Ç–æ–¥–æ–≤: –ü–æ–ª–Ω–æ–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ

## –í–≤–µ–¥–µ–Ω–∏–µ: –õ–∏—Ñ—Ç –∫–∞–∫ –∞–Ω–∞–ª–æ–≥–∏—è

–ü—Ä–µ–¥—Å—Ç–∞–≤—å—Ç–µ, —á—Ç–æ –≤—ã —Å—Ç–æ–∏—Ç–µ –ø–µ—Ä–µ–¥ –ª–∏—Ñ—Ç–æ–º –Ω–∞ 5-–º —ç—Ç–∞–∂–µ –∏ —Ö–æ—Ç–∏—Ç–µ —Å–ø—É—Å—Ç–∏—Ç—å—Å—è –Ω–∞ 1-–π —ç—Ç–∞–∂. –í—ã –Ω–∞–∂–∏–º–∞–µ—Ç–µ –∫–Ω–æ–ø–∫—É –≤—ã–∑–æ–≤–∞ –æ–¥–∏–Ω —Ä–∞–∑. –ó–∞—Ç–µ–º, –Ω–µ—Ä–≤–Ω–∏—á–∞—è –∏ –¥—É–º–∞—è —á—Ç–æ –∫–Ω–æ–ø–∫–∞ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª–∞, –Ω–∞–∂–∏–º–∞–µ—Ç–µ –µ—â–µ —Ä–∞–∑. –ò –µ—â–µ —Ä–∞–∑.

–ß—Ç–æ –ø—Ä–æ–∏–∑–æ–π–¥–µ—Ç? –õ–∏—Ñ—Ç –ø—Ä–∏–µ–¥–µ—Ç –Ω–∞ 5-–π —ç—Ç–∞–∂ **–æ–¥–∏–Ω —Ä–∞–∑**, –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç —Ç–æ–≥–æ, —Å–∫–æ–ª—å–∫–æ —Ä–∞–∑ –≤—ã –Ω–∞–∂–∞–ª–∏ –∫–Ω–æ–ø–∫—É. –ö–æ–Ω–µ—á–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –æ–¥–∏–Ω–∞–∫–æ–≤: –ª–∏—Ñ—Ç –Ω–∞ 5-–º —ç—Ç–∞–∂–µ, –≤—ã –≤–Ω—É—Ç—Ä–∏, –µ–¥–µ—Ç–µ –Ω–∞ 1-–π —ç—Ç–∞–∂.

**–≠—Ç–æ –∏ –µ—Å—Ç—å –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å!**

–í –º–∏—Ä–µ HTTP API –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ –ø–æ–≤—Ç–æ—Ä–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –æ–¥–Ω–æ–π –∏ —Ç–æ–π –∂–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –¥–∞–µ—Ç —Ç–æ—Ç –∂–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç, —á—Ç–æ –∏ –æ–¥–Ω–æ–∫—Ä–∞—Ç–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ.

> –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å = –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

---

## –ß—Ç–æ —Ç–∞–∫–æ–µ –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å?

### –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ

**–ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω—ã–π –º–µ—Ç–æ–¥** ‚Äî —ç—Ç–æ HTTP –º–µ—Ç–æ–¥, –ø—Ä–∏ –∫–æ—Ç–æ—Ä–æ–º –º–Ω–æ–≥–æ–∫—Ä–∞—Ç–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –æ–¥–Ω–æ–≥–æ –∏ —Ç–æ–≥–æ –∂–µ –∑–∞–ø—Ä–æ—Å–∞ –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ —Ç–æ–º—É –∂–µ —Å–æ—Å—Ç–æ—è–Ω–∏—é —Ä–µ—Å—É—Ä—Å–∞, —á—Ç–æ –∏ –æ–¥–Ω–æ–∫—Ä–∞—Ç–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ.

**–ü—Ä–æ—Å—Ç—ã–º–∏ —Å–ª–æ–≤–∞–º–∏**: –ù–µ–≤–∞–∂–Ω–æ —Å–∫–æ–ª—å–∫–æ —Ä–∞–∑ –≤—ã –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ –∑–∞–ø—Ä–æ—Å ‚Äî —Ä–µ–∑—É–ª—å—Ç–∞—Ç –±—É–¥–µ—Ç –æ–¥–∏–Ω–∞–∫–æ–≤—ã–º.

### –§–æ—Ä–º–∞–ª—å–Ω–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ (RFC 7231)

> –ú–µ—Ç–æ–¥ —Å—á–∏—Ç–∞–µ—Ç—Å—è –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω—ã–º, –µ—Å–ª–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∏–¥–µ–Ω—Ç–∏—á–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ –≤—Å–µ–≥–¥–∞ –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ —Ç–æ–º—É –∂–µ —Å–æ—Å—Ç–æ—è–Ω–∏—é —Å–µ—Ä–≤–µ—Ä–∞, —á—Ç–æ –∏ –ø–µ—Ä–≤—ã–π –∑–∞–ø—Ä–æ—Å.

**–í–∞–∂–Ω–æ**: –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –∫–∞—Å–∞–µ—Ç—Å—è **—Å–æ—Å—Ç–æ—è–Ω–∏—è —Ä–µ—Å—É—Ä—Å–∞**, –∞ –Ω–µ **–∫–æ–¥–∞ –æ—Ç–≤–µ—Ç–∞**!

---

## –ö–∞–∫–∏–µ –º–µ—Ç–æ–¥—ã –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω—ã?

### –¢–∞–±–ª–∏—Ü–∞ –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏ HTTP –º–µ—Ç–æ–¥–æ–≤

| HTTP –º–µ—Ç–æ–¥ | –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–µ–Ω? | Safe? | –ü—Ä–∏–º–µ—Ä |
|------------|---------------|-------|--------|
| **GET** | –î–∞ | –î–∞ | –ü–æ–ª—É—á–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è |
| **HEAD** | –î–∞ | –î–∞ | –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ |
| **OPTIONS** | –î–∞ | –î–∞ | –ü–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø–Ω—ã–µ –º–µ—Ç–æ–¥—ã |
| **PUT** | –î–∞ | –ù–µ—Ç | –ó–∞–º–µ–Ω–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è |
| **DELETE** | –î–∞ | –ù–µ—Ç | –£–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è |
| **POST** | –ù–µ—Ç | –ù–µ—Ç | –°–æ–∑–¥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è |
| **PATCH** | –ó–∞–≤–∏—Å–∏—Ç | –ù–µ—Ç | –û–±–Ω–æ–≤–∏—Ç—å –ø–æ–ª–µ |

### GET, HEAD, OPTIONS ‚Äî –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω—ã –∏ –ë–µ–∑–æ–ø–∞—Å–Ω—ã

**–ü—Ä–∏–º–µ—Ä GET**:

–ü–µ—Ä–≤—ã–π –∑–∞–ø—Ä–æ—Å:
GET /users/123

HTTP/1.1 200 OK
{"id": "123", "name": "Ivan"}

–í—Ç–æ—Ä–æ–π –∑–∞–ø—Ä–æ—Å (–∏–¥–µ–Ω—Ç–∏—á–Ω—ã–π):
GET /users/123

HTTP/1.1 200 OK
{"id": "123", "name": "Ivan"}

–†–µ–∑—É–ª—å—Ç–∞—Ç: **—Ç–æ—Ç –∂–µ —Ä–µ—Å—É—Ä—Å**, **—Ç–æ –∂–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ**.

### PUT ‚Äî –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–µ–Ω, –Ω–æ –Ω–µ Safe

**–ü—Ä–∏–º–µ—Ä**:

–ü–µ—Ä–≤—ã–π –∑–∞–ø—Ä–æ—Å:
PUT /users/123
{"name": "Ivan", "age": 28}

–°–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ—Å–ª–µ: name=Ivan, age=28

–í—Ç–æ—Ä–æ–π –∑–∞–ø—Ä–æ—Å (–∏–¥–µ–Ω—Ç–∏—á–Ω—ã–π):
PUT /users/123
{"name": "Ivan", "age": 28}

–°–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ—Å–ª–µ: name=Ivan, age=28 (–¢–û –ñ–ï!)

**–í—ã–≤–æ–¥**: PUT –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–µ–Ω, –ø–æ—Ç–æ–º—É —á—Ç–æ –º–Ω–æ–≥–æ–∫—Ä–∞—Ç–Ω–æ–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –¥–∞–µ—Ç —Ç–æ—Ç –∂–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç.

### DELETE ‚Äî –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–µ–Ω

**–ü—Ä–∏–º–µ—Ä**:

–ü–µ—Ä–≤—ã–π DELETE:
DELETE /users/123

–°–æ—Å—Ç–æ—è–Ω–∏–µ: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å 123 —É–¥–∞–ª–µ–Ω

–í—Ç–æ—Ä–æ–π DELETE:
DELETE /users/123

–°–æ—Å—Ç–æ—è–Ω–∏–µ: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å 123 –≤—Å–µ –µ—â–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç (–¢–û –ñ–ï –°–û–°–¢–û–Ø–ù–ò–ï!)

**–í–æ–ø—Ä–æ—Å**: –ù–æ –≤–µ–¥—å –≤—Ç–æ—Ä–æ–π DELETE –≤–µ—Ä–Ω–µ—Ç 404 Not Found, –∞ –Ω–µ 204 No Content?

**–û—Ç–≤–µ—Ç**: –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –æ **—Å–æ—Å—Ç–æ—è–Ω–∏–∏ —Ä–µ—Å—É—Ä—Å–∞**, –Ω–µ –æ –∫–æ–¥–µ –æ—Ç–≤–µ—Ç–∞!

–ö–æ–Ω–µ—á–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ–¥–∏–Ω–∞–∫–æ–≤–æ: —Ä–µ—Å—É—Ä—Å –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç. –ö–æ–¥ –æ—Ç–≤–µ—Ç–∞ –º–æ–∂–µ—Ç –æ—Ç–ª–∏—á–∞—Ç—å—Å—è, –Ω–æ —ç—Ç–æ –Ω–µ –Ω–∞—Ä—É—à–∞–µ—Ç –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å.

### POST ‚Äî –ù–ï –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–µ–Ω

**–ü—Ä–∏–º–µ—Ä**:

–ü–µ—Ä–≤—ã–π POST:
POST /users
{"name": "Ivan"}

–°–æ–∑–¥–∞–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å ID=1

–í—Ç–æ—Ä–æ–π POST (–∏–¥–µ–Ω—Ç–∏—á–Ω—ã–π):
POST /users
{"name": "Ivan"}

–°–æ–∑–¥–∞–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å ID=2 (–î–£–ë–õ–ò–ö–ê–¢!)

**–í—ã–≤–æ–¥**: POST –Ω–µ –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–µ–Ω, –∫–∞–∂–¥—ã–π –∑–∞–ø—Ä–æ—Å —Å–æ–∑–¥–∞–µ—Ç –Ω–æ–≤—ã–π —Ä–µ—Å—É—Ä—Å.

### PATCH ‚Äî –ó–∞–≤–∏—Å–∏—Ç –æ—Ç —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

**–ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω—ã–π PATCH (–∑–∞–º–µ–Ω–∞ –∑–Ω–∞—á–µ–Ω–∏—è)**:

PATCH /users/123
{"email": "new@example.com"}

–ü–µ—Ä–≤–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ: email = new@example.com
–í—Ç–æ—Ä–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ: email = new@example.com (–¢–û –ñ–ï!)

**–ù–ï –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω—ã–π PATCH (increment)**:

PATCH /users/123
{"views": {"$inc": 1}}

–ü–µ—Ä–≤–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ: views = 101
–í—Ç–æ—Ä–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ: views = 102 (–†–ê–ó–ù–û–ï!)

**–í—ã–≤–æ–¥**: PATCH –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–µ–Ω, –µ—Å–ª–∏ –æ–ø–µ—Ä–∞—Ü–∏—è –∑–∞–º–µ–Ω—è–µ—Ç –∑–Ω–∞—á–µ–Ω–∏–µ, –∏ –Ω–µ –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–µ–Ω, –µ—Å–ª–∏ –∏–∑–º–µ–Ω—è–µ—Ç –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è.

---

## –ü–æ—á–µ–º—É –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –≤–∞–∂–Ω–∞?

### –ü—Ä–æ–±–ª–µ–º–∞ 1: –°–µ—Ç–µ–≤—ã–µ —Ç–∞–π–º–∞—É—Ç—ã

**–°—Ü–µ–Ω–∞—Ä–∏–π**:

1. –ö–ª–∏–µ–Ω—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç PUT /users/123
2. –°–µ—Ä–≤–µ—Ä –æ–±—Ä–∞–±–æ—Ç–∞–ª –∑–∞–ø—Ä–æ—Å, –Ω–æ –æ—Ç–≤–µ—Ç –ø–æ—Ç–µ—Ä—è–ª—Å—è –≤ —Å–µ—Ç–∏
3. –ö–ª–∏–µ–Ω—Ç –Ω–µ –ø–æ–ª—É—á–∏–ª –æ—Ç–≤–µ—Ç (timeout)
4. –ö–ª–∏–µ–Ω—Ç –ø–æ–≤—Ç–æ—Ä—è–µ—Ç PUT /users/123

**–° –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω—ã–º PUT**:
- –ü–æ–≤—Ç–æ—Ä–Ω—ã–π –∑–∞–ø—Ä–æ—Å –±–µ–∑–æ–ø–∞—Å–µ–Ω
- –°–æ—Å—Ç–æ—è–Ω–∏–µ —Ç–æ –∂–µ, —á—Ç–æ –∏ –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
- –í—Å–µ —Ö–æ—Ä–æ—à–æ!

**–° –Ω–µ–∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω—ã–º POST**:
- –ü–æ–≤—Ç–æ—Ä–Ω—ã–π –∑–∞–ø—Ä–æ—Å —Å–æ–∑–¥–∞—Å—Ç –¥—É–±–ª–∏–∫–∞—Ç
- –ü—Ä–æ–±–ª–µ–º–∞!

### –ü—Ä–æ–±–ª–µ–º–∞ 2: –ù–µ–Ω–∞–¥–µ–∂–Ω—ã–µ —Å–µ—Ç–∏

–í –Ω–µ–Ω–∞–¥–µ–∂–Ω—ã—Ö —Å–µ—Ç—è—Ö (–º–æ–±–∏–ª—å–Ω—ã–π –∏–Ω—Ç–µ—Ä–Ω–µ—Ç, Wi-Fi –≤ –º–µ—Ç—Ä–æ) –ø–∞–∫–µ—Ç—ã –º–æ–≥—É—Ç:
- –î—É–±–ª–∏—Ä–æ–≤–∞—Ç—å—Å—è
- –¢–µ—Ä—è—Ç—å—Å—è
- –ü—Ä–∏—Ö–æ–¥–∏—Ç—å —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π

–ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω—ã–µ –º–µ—Ç–æ–¥—ã –ø–æ–∑–≤–æ–ª—è—é—Ç –±–µ–∑–æ–ø–∞—Å–Ω–æ –ø–æ–≤—Ç–æ—Ä—è—Ç—å –∑–∞–ø—Ä–æ—Å—ã!

### –ü—Ä–æ–±–ª–µ–º–∞ 3: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ retry

–ú–Ω–æ–≥–∏–µ HTTP –∫–ª–∏–µ–Ω—Ç—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–≤—Ç–æ—Ä—è—é—Ç –Ω–µ—É–¥–∞—á–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã:

- Axios: –æ–ø—Ü–∏—è retry
- Fetch API: –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å retry –ª–æ–≥–∏–∫—É
- Nginx: proxy_next_upstream

–ï—Å–ª–∏ –º–µ—Ç–æ–¥ –Ω–µ –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–µ–Ω, –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π retry –º–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –¥—É–±–ª–∏–∫–∞—Ç–∞–º!

---

## Safe (–±–µ–∑–æ–ø–∞—Å–Ω—ã–µ) –º–µ—Ç–æ–¥—ã

### –ß—Ç–æ —Ç–∞–∫–æ–µ Safe –º–µ—Ç–æ–¥?

**Safe (–±–µ–∑–æ–ø–∞—Å–Ω—ã–π) –º–µ—Ç–æ–¥** ‚Äî —ç—Ç–æ –º–µ—Ç–æ–¥, –∫–æ—Ç–æ—Ä—ã–π **–ù–ï –∏–∑–º–µ–Ω—è–µ—Ç** —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–µ—Ä–≤–µ—Ä–∞.

**Safe –º–µ—Ç–æ–¥—ã**: GET, HEAD, OPTIONS, TRACE

**–í—Å–µ safe –º–µ—Ç–æ–¥—ã –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω—ã**, –Ω–æ –Ω–µ –Ω–∞–æ–±–æ—Ä–æ—Ç!

| –ú–µ—Ç–æ–¥ | Safe? | –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–µ–Ω? |
|-------|-------|---------------|
| GET | –î–∞ | –î–∞ |
| PUT | –ù–µ—Ç | –î–∞ |
| DELETE | –ù–µ—Ç | –î–∞ |
| POST | –ù–µ—Ç | –ù–µ—Ç |

**–ü—Ä–∏–º–µ—Ä—ã**:

Safe –∏ –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–µ–Ω: GET
–ù–ï safe, –Ω–æ –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–µ–Ω: PUT, DELETE
–ù–ï safe –∏ –ù–ï –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–µ–Ω: POST

---

## Idempotency-Key –∑–∞–≥–æ–ª–æ–≤–æ–∫

### –ü—Ä–æ–±–ª–µ–º–∞: –ö–∞–∫ —Å–¥–µ–ª–∞—Ç—å POST –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω—ã–º?

POST –ø–æ —Å–≤–æ–µ–π –ø—Ä–∏—Ä–æ–¥–µ –Ω–µ –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–µ–Ω. –ù–æ —á—Ç–æ –µ—Å–ª–∏ –Ω–∞–º –Ω—É–∂–Ω–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ –ø–æ–≤—Ç–æ—Ä—è—Ç—å POST (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Å–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞)?

**–†–µ—à–µ–Ω–∏–µ**: Idempotency-Key –∑–∞–≥–æ–ª–æ–≤–æ–∫!

### –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç Idempotency-Key

**–ò–¥–µ—è**: –ö–ª–∏–µ–Ω—Ç –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–ª—é—á –¥–ª—è –∫–∞–∂–¥–æ–π –æ–ø–µ—Ä–∞—Ü–∏–∏. –°–µ—Ä–≤–µ—Ä –∑–∞–ø–æ–º–∏–Ω–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø–µ—Ä–≤–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ —Å —ç—Ç–∏–º –∫–ª—é—á–æ–º –∏ –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–æ—Ç –∂–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç.

**–ü—Ä–∏–º–µ—Ä**:

–ü–µ—Ä–≤—ã–π –∑–∞–ø—Ä–æ—Å:
POST /payments HTTP/1.1
Idempotency-Key: unique-key-abc-123
Content-Type: application/json

{
  "amount": 1000,
  "currency": "RUB",
  "description": "–û–ø–ª–∞—Ç–∞ –∑–∞–∫–∞–∑–∞ #789"
}

–û—Ç–≤–µ—Ç:
HTTP/1.1 201 Created
{
  "paymentId": "pay_xyz",
  "status": "completed"
}

–ü–æ–≤—Ç–æ—Ä–Ω—ã–π –∑–∞–ø—Ä–æ—Å (—Å —Ç–µ–º –∂–µ –∫–ª—é—á–æ–º):
POST /payments HTTP/1.1
Idempotency-Key: unique-key-abc-123
Content-Type: application/json

{
  "amount": 1000,
  "currency": "RUB",
  "description": "–û–ø–ª–∞—Ç–∞ –∑–∞–∫–∞–∑–∞ #789"
}

–û—Ç–≤–µ—Ç (–¢–û–¢ –ñ–ï!):
HTTP/1.1 200 OK
{
  "paymentId": "pay_xyz",
  "status": "completed"
}

**–û–±—Ä–∞—Ç–∏—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ**: –í–µ—Ä–Ω—É–ª—Å—è —Ç–æ—Ç –∂–µ payment, –Ω–µ —Å–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π!

### –ö–∞–∫ –¥–æ–ª–≥–æ —Ö—Ä–∞–Ω–∏—Ç—å Idempotency-Key?

**–û—Ç–≤–µ—Ç**: –ó–∞–≤–∏—Å–∏—Ç –æ—Ç API!

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏**:
- **–ú–∏–Ω–∏–º—É–º**: 24 —á–∞—Å–∞
- **–û–ø—Ç–∏–º–∞–ª—å–Ω–æ**: 7 –¥–Ω–µ–π
- **Stripe API**: 24 —á–∞—Å–∞
- **PayPal**: 30 –¥–Ω–µ–π

**–ü—Ä–∏–º–µ—Ä —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏**:

// –°–µ—Ä–≤–µ—Ä –ø—Ä–æ–≤–µ—Ä—è–µ—Ç Idempotency-Key
const idempotencyKey = request.headers['idempotency-key'];

if (idempotencyKey) {
  const cached = await cache.get(idempotencyKey);

  if (cached) {
    // –í–µ—Ä–Ω—É—Ç—å –∑–∞–∫–µ—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
    return response.status(200).json(cached.result);
  }
}

// –í—ã–ø–æ–ª–Ω–∏—Ç—å –æ–ø–µ—Ä–∞—Ü–∏—é
const result = await createPayment(request.body);

// –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç
await cache.set(idempotencyKey, { result }, { ttl: 86400 }); // 24 —á–∞—Å–∞

return response.status(201).json(result);

---

## –†–∞–∑–Ω–∏—Ü–∞ –º–µ–∂–¥—É PUT –∏ PATCH

### PUT ‚Äî –í—Å–µ–≥–¥–∞ –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–µ–Ω

PUT –∑–∞–º–µ–Ω—è–µ—Ç —Ä–µ—Å—É—Ä—Å **–ø–æ–ª–Ω–æ—Å—Ç—å—é**.

–ü–µ—Ä–≤—ã–π PUT:
PUT /users/123
{"name": "Ivan", "age": 28}

–°–æ—Å—Ç–æ—è–Ω–∏–µ: name=Ivan, age=28

–í—Ç–æ—Ä–æ–π PUT (–∏–¥–µ–Ω—Ç–∏—á–Ω—ã–π):
PUT /users/123
{"name": "Ivan", "age": 28}

–°–æ—Å—Ç–æ—è–Ω–∏–µ: name=Ivan, age=28 (–¢–û –ñ–ï!)

### PATCH ‚Äî –ó–∞–≤–∏—Å–∏—Ç –æ—Ç –æ–ø–µ—Ä–∞—Ü–∏–∏

**–ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω—ã–π PATCH** (set/replace):

PATCH /users/123
{"name": "Ivan"}

–ü–µ—Ä–≤—ã–π —Ä–∞–∑: name = Ivan
–í—Ç–æ—Ä–æ–π —Ä–∞–∑: name = Ivan (–¢–û –ñ–ï!)

**–ù–ï –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω—ã–π PATCH** (increment/decrement):

PATCH /articles/123
{"views": {"$inc": 1}}

–ü–µ—Ä–≤—ã–π —Ä–∞–∑: views = 101
–í—Ç–æ—Ä–æ–π —Ä–∞–∑: views = 102 (–†–ê–ó–ù–û–ï!)

**–ù–ï –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω—ã–π PATCH** (append):

PATCH /users/123
{"tags": {"$push": "new-tag"}}

–ü–µ—Ä–≤—ã–π —Ä–∞–∑: tags = ["old", "new-tag"]
–í—Ç–æ—Ä–æ–π —Ä–∞–∑: tags = ["old", "new-tag", "new-tag"] (–î–£–ë–õ–ò–ö–ê–¢!)

**–í—ã–≤–æ–¥**: PATCH –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–µ–Ω, –µ—Å–ª–∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –∞–±—Å–æ–ª—é—Ç–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è, –∏ –Ω–µ –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–µ–Ω, –µ—Å–ª–∏ –∏–∑–º–µ–Ω—è–µ—Ç –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ —Ç–µ–∫—É—â–µ–≥–æ.

---

## DELETE –∏ –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å

### –ü–æ—á–µ–º—É DELETE –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–µ–Ω?

**–ö–ª—é—á–µ–≤–∞—è –∏–¥–µ—è**: –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –æ **–∫–æ–Ω–µ—á–Ω–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏**, –Ω–µ –æ –∫–æ–¥–µ –æ—Ç–≤–µ—Ç–∞!

**–ü–µ—Ä–≤—ã–π DELETE**:

DELETE /users/123

HTTP/1.1 204 No Content

–°–æ—Å—Ç–æ—è–Ω–∏–µ: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å 123 –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç

**–í—Ç–æ—Ä–æ–π DELETE**:

DELETE /users/123

HTTP/1.1 404 Not Found
{
  "error": "User not found"
}

–°–æ—Å—Ç–æ—è–Ω–∏–µ: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å 123 –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç (–¢–û –ñ–ï –°–û–°–¢–û–Ø–ù–ò–ï!)

**–í—ã–≤–æ–¥**: –ö–æ–¥ –æ—Ç–≤–µ—Ç–∞ —Ä–∞–∑–Ω—ã–π (204 vs 404), –Ω–æ **—Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ–¥–∏–Ω–∞–∫–æ–≤–æ** ‚Äî —Ä–µ—Å—É—Ä—Å –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç.

### –í–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç–≤–µ—Ç–æ–≤ –Ω–∞ –ø–æ–≤—Ç–æ—Ä–Ω—ã–π DELETE

**–í–∞—Ä–∏–∞–Ω—Ç 1: 404 Not Found**

–õ–æ–≥–∏–∫–∞: —Ä–µ—Å—É—Ä—Å –Ω–µ –Ω–∞–π–¥–µ–Ω

DELETE /users/123 (—É–∂–µ —É–¥–∞–ª–µ–Ω)

HTTP/1.1 404 Not Found

**–í–∞—Ä–∏–∞–Ω—Ç 2: 204 No Content (–∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω—ã–π –ø–æ–¥—Ö–æ–¥)**

–õ–æ–≥–∏–∫–∞: –æ–ø–µ—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞, —Ä–µ—Å—É—Ä—Å –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç

DELETE /users/123 (—É–∂–µ —É–¥–∞–ª–µ–Ω)

HTTP/1.1 204 No Content

**–í–∞—Ä–∏–∞–Ω—Ç 3: 410 Gone**

–õ–æ–≥–∏–∫–∞: —Ä–µ—Å—É—Ä—Å –±—ã–ª —É–¥–∞–ª–µ–Ω —Ä–∞–Ω–µ–µ

DELETE /users/123 (—É–¥–∞–ª–µ–Ω –≤—á–µ—Ä–∞)

HTTP/1.1 410 Gone
{
  "deletedAt": "2024-01-07T10:00:00Z"
}

**–í—Å–µ —Ç—Ä–∏ –≤–∞—Ä–∏–∞–Ω—Ç–∞ –¥–æ–ø—É—Å—Ç–∏–º—ã!** –í—ã–±–æ—Ä –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –≤–∞—à–µ–≥–æ API.

---

## –†–µ—à–µ–Ω–∏–µ —Ç–∏–ø–∏—á–Ω—ã—Ö –∑–∞–¥–∞—á

### –ó–∞–¥–∞—á–∞ 1: –ß—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å?

**–û—Ç–≤–µ—Ç**: –ú–Ω–æ–≥–æ–∫—Ä–∞—Ç–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–∞–µ—Ç —Ç–æ—Ç –∂–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç

**–ü—Ä–∏–º–µ—Ä—ã**:
- PUT –æ–¥–∏–Ω —Ä–∞–∑ = PUT 10 —Ä–∞–∑ (—Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ç–æ –∂–µ)
- DELETE –æ–¥–∏–Ω —Ä–∞–∑ = DELETE 10 —Ä–∞–∑ (—Ä–µ—Å—É—Ä—Å –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç)

### –ó–∞–¥–∞—á–∞ 2: –ö–∞–∫–æ–π –º–µ—Ç–æ–¥ –ù–ï –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–µ–Ω?

**–û—Ç–≤–µ—Ç**: POST

**–ü–æ—á–µ–º—É**: –ö–∞–∂–¥—ã–π POST —Å–æ–∑–¥–∞–µ—Ç –Ω–æ–≤—ã–π —Ä–µ—Å—É—Ä—Å.

POST /users -> user ID=1
POST /users -> user ID=2 (–¥—É–±–ª–∏–∫–∞—Ç!)

### –ó–∞–¥–∞—á–∞ 3: DELETE –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–µ–Ω?

**–û—Ç–≤–µ—Ç**: –î–∞

**–ü–æ—á–µ–º—É**: –ö–æ–Ω–µ—á–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ–¥–∏–Ω–∞–∫–æ–≤–æ ‚Äî —Ä–µ—Å—É—Ä—Å –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç.

### –ó–∞–¥–∞—á–∞ 4: –†–∞–∑–Ω–∏—Ü–∞ PUT –∏ PATCH –ø–æ –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏?

**–û—Ç–≤–µ—Ç**: PUT –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω—ã–π, PATCH –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

PUT –≤—Å–µ–≥–¥–∞ –∑–∞–º–µ–Ω—è–µ—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é -> –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–µ–Ω
PATCH –º–æ–∂–µ—Ç –∏–∑–º–µ–Ω—è—Ç—å –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ (increment) -> –Ω–µ –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–µ–Ω

### –ó–∞–¥–∞—á–∞ 5: –ü–æ—á–µ–º—É –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –≤–∞–∂–Ω–∞?

**–û—Ç–≤–µ—Ç**: –î–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

**–ü—Ä–∏–º–µ—Ä—ã**:
- –°–µ—Ç–µ–≤—ã–µ —Ç–∞–π–º–∞—É—Ç—ã
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ retry
- –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞–∫–µ—Ç–æ–≤ –≤ —Å–µ—Ç–∏

### –ó–∞–¥–∞—á–∞ 6: –ö–∞–∫–∏–µ –º–µ—Ç–æ–¥—ã –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω—ã?

**–û—Ç–≤–µ—Ç**: GET, PUT, DELETE, HEAD, OPTIONS

**–ù–µ –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–µ–Ω**: POST

### –ó–∞–¥–∞—á–∞ 7: PATCH –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–µ–Ω?

**–û—Ç–≤–µ—Ç**: –ó–∞–≤–∏—Å–∏—Ç –æ—Ç —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

**–ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω—ã–π**: PATCH {"name": "Ivan"} (–∑–∞–º–µ–Ω–∞)
**–ù–ï –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω—ã–π**: PATCH {"views": {"$inc": 1}} (increment)

### –ó–∞–¥–∞—á–∞ 8: –ß—Ç–æ —Ç–∞–∫–æ–µ Idempotency-Key?

**–û—Ç–≤–µ—Ç**: –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–ª—é—á –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –¥—É–±–ª–∏–∫–∞—Ç–æ–≤

–ö–ª–∏–µ–Ω—Ç –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∫–ª—é—á, —Å–µ—Ä–≤–µ—Ä –∑–∞–ø–æ–º–∏–Ω–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç.

### –ó–∞–¥–∞—á–∞ 9: –ö–∞–∫ –¥–æ–ª–≥–æ —Ö—Ä–∞–Ω–∏—Ç—å Idempotency-Key?

**–û—Ç–≤–µ—Ç**: –ó–∞–≤–∏—Å–∏—Ç –æ—Ç API

–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏: 24 —á–∞—Å–∞ - 7 –¥–Ω–µ–π

### –ó–∞–¥–∞—á–∞ 10: –ü–æ–≤—Ç–æ—Ä–Ω—ã–π POST —Å —Ç–µ–º –∂–µ –∫–ª—é—á–æ–º?

**–û—Ç–≤–µ—Ç**: –¢–æ—Ç –∂–µ –æ—Ç–≤–µ—Ç —á—Ç–æ –∏ –ø–µ—Ä–≤—ã–π —Ä–∞–∑

–°–µ—Ä–≤–µ—Ä –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∑–∞–∫–µ—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø–µ—Ä–≤–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞.

### –ó–∞–¥–∞—á–∞ 11: –ü–æ—á–µ–º—É DELETE –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–µ–Ω –µ—Å–ª–∏ 404?

**–û—Ç–≤–µ—Ç**: –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –æ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ —Ä–µ—Å—É—Ä—Å–∞, –Ω–µ –æ –∫–æ–¥–µ –æ—Ç–≤–µ—Ç–∞

–°–æ—Å—Ç–æ—è–Ω–∏–µ –æ–¥–∏–Ω–∞–∫–æ–≤–æ: —Ä–µ—Å—É—Ä—Å –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç.

### –ó–∞–¥–∞—á–∞ 12: –ú–æ–∂–Ω–æ –ª–∏ —Å–¥–µ–ª–∞—Ç—å POST –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω—ã–º?

**–û—Ç–≤–µ—Ç**: –î–∞, —Å Idempotency-Key –∏–ª–∏ –µ—Å–ª–∏ –æ–ø–µ—Ä–∞—Ü–∏—è –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–∞

–ü—Ä–∏–º–µ—Ä—ã:
- Idempotency-Key –∑–∞–≥–æ–ª–æ–≤–æ–∫
- –õ–æ–≥–∏–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ (–ø—Ä–æ–≤–µ—Ä–∫–∞ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤)
- UUID –≤ –∑–∞–ø—Ä–æ—Å–µ

### –ó–∞–¥–∞—á–∞ 13: –ß—Ç–æ —Ç–∞–∫–æ–µ safe –º–µ—Ç–æ–¥?

**–û—Ç–≤–µ—Ç**: –ù–µ –∏–∑–º–µ–Ω—è–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–µ—Ä–≤–µ—Ä–∞

Safe –º–µ—Ç–æ–¥—ã: GET, HEAD, OPTIONS

### –ó–∞–¥–∞—á–∞ 14: –í—Å–µ –ª–∏ safe –º–µ—Ç–æ–¥—ã –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω—ã?

**–û—Ç–≤–µ—Ç**: –î–∞

GET, HEAD, OPTIONS - –≤—Å–µ –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω—ã.

–ù–æ –Ω–µ –≤—Å–µ –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω—ã–µ –º–µ—Ç–æ–¥—ã safe (PUT, DELETE –Ω–µ safe).

### –ó–∞–¥–∞—á–∞ 15: PATCH increment –Ω–µ –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–µ–Ω?

**–û—Ç–≤–µ—Ç**: –ü–æ–≤—Ç–æ—Ä–Ω—ã–µ increment –¥–∞—é—Ç —Ä–∞–∑–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

PATCH {"views": {"$inc": 1}}

–ü–µ—Ä–≤—ã–π —Ä–∞–∑: views = 101
–í—Ç–æ—Ä–æ–π —Ä–∞–∑: views = 102 (–†–ê–ó–ù–û–ï!)

---

## Best Practices

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

1. **–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω—ã–µ –º–µ—Ç–æ–¥—ã –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏–π**
   - PUT –≤–º–µ—Å—Ç–æ POST –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
   - DELETE –±–µ–∑–æ–ø–∞—Å–µ–Ω –¥–ª—è –ø–æ–≤—Ç–æ—Ä–æ–≤

2. **–î–ª—è POST –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ Idempotency-Key**
   - –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ (–ø–ª–∞—Ç–µ–∂–∏, –∑–∞–∫–∞–∑—ã)
   - –•—Ä–∞–Ω–∏—Ç–µ –∫–ª—é—á–∏ 24 —á–∞—Å–∞ –º–∏–Ω–∏–º—É–º

3. **–î–æ–∫—É–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å PATCH**
   - –£–∫–∞–∂–∏—Ç–µ –∫–∞–∫–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω—ã
   - Increment/decrement –Ω–µ –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω—ã

4. **–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–π—Ç–µ –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ DELETE**
   - –í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏—é: 404, 204, –∏–ª–∏ 410
   - –ë—É–¥—å—Ç–µ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã

5. **–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ If-Match –¥–ª—è –æ–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω–æ–π –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏**
   - –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã –ø—Ä–∏ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ü–∏–∏
   - –†–∞–±–æ—Ç–∞–µ—Ç —Å –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω—ã–º–∏ –º–µ—Ç–æ–¥–∞–º–∏

### –ß—Ç–æ –ù–ï –¥–µ–ª–∞—Ç—å

1. –ù–µ –¥–µ–ª–∞–π—Ç–µ GET –∏–∑–º–µ–Ω—è—é—â–∏–º –¥–∞–Ω–Ω—ã–µ
2. –ù–µ –ø–æ–ª–∞–≥–∞–π—Ç–µ—Å—å –Ω–∞ POST –±–µ–∑ Idempotency-Key
3. –ù–µ –∏–≥–Ω–æ—Ä–∏—Ä—É–π—Ç–µ –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã
4. –ù–µ –∑–∞–±—ã–≤–∞–π—Ç–µ –ø—Ä–æ —Å–µ—Ç–µ–≤—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

---

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

### –ö–ª—é—á–µ–≤—ã–µ –º–æ–º–µ–Ω—Ç—ã

1. **–ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å** = –º–Ω–æ–≥–æ–∫—Ä–∞—Ç–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–∞–µ—Ç —Ç–æ—Ç –∂–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç
2. **–ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω—ã–µ –º–µ—Ç–æ–¥—ã**: GET, PUT, DELETE, HEAD, OPTIONS
3. **–ù–ï –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω—ã–π**: POST
4. **PATCH**: –∑–∞–≤–∏—Å–∏—Ç (set - –¥–∞, increment - –Ω–µ—Ç)
5. **Safe –º–µ—Ç–æ–¥—ã** (GET, HEAD, OPTIONS) –≤—Å–µ–≥–¥–∞ –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω—ã
6. **Idempotency-Key** –¥–µ–ª–∞–µ—Ç POST –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω—ã–º
7. **DELETE –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–µ–Ω** –ø–æ —Å–æ—Å—Ç–æ—è–Ω–∏—é, –Ω–µ –ø–æ –∫–æ–¥—É –æ—Ç–≤–µ—Ç–∞

### –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–µ–±—è

–ü–æ—Å–ª–µ –∏–∑—É—á–µ–Ω–∏—è –≤—ã –¥–æ–ª–∂–Ω—ã —É–º–µ—Ç—å:
- –û–ø—Ä–µ–¥–µ–ª—è—Ç—å –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω—ã–µ –º–µ—Ç–æ–¥—ã
- –û–±—ä—è—Å–Ω—è—Ç—å —Ä–∞–∑–Ω–∏—Ü—É –º–µ–∂–¥—É safe –∏ –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω—ã–º–∏
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Idempotency-Key
- –ü–æ–Ω–∏–º–∞—Ç—å –∫–æ–≥–¥–∞ PATCH –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–µ–Ω
- –ü—Ä–∞–≤–∏–ª—å–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ DELETE
- –û–±—ä—è—Å–Ω—è—Ç—å –≤–∞–∂–Ω–æ—Å—Ç—å –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏

–¢–µ–ø–µ—Ä—å –≤—ã –≥–æ—Ç–æ–≤—ã —Å–æ–∑–¥–∞–≤–∞—Ç—å –Ω–∞–¥–µ–∂–Ω—ã–µ –∏ –±–µ–∑–æ–ø–∞—Å–Ω—ã–µ –¥–ª—è –ø–æ–≤—Ç–æ—Ä–æ–≤ API! üéâ
`;

const lectureContent = cleanContent(lectureContentRaw);

async function createLecture() {
  try {
    console.log('üîç –ü–æ–∏—Å–∫ —Ç–µ—Å—Ç–∞ "–ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –º–µ—Ç–æ–¥–æ–≤"...\n');

    const test = await prisma.test.findFirst({
      where: {
        title: { contains: '–ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å' },
      },
      include: {
        questions: {
          include: {
            question: true,
          },
          orderBy: {
            order: 'asc',
          },
        },
      },
    });

    if (!test) {
      console.error('‚ùå –¢–µ—Å—Ç "–ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –º–µ—Ç–æ–¥–æ–≤" –Ω–µ –Ω–∞–π–¥–µ–Ω');
      return;
    }

    console.log(`‚úÖ –ù–∞–π–¥–µ–Ω —Ç–µ—Å—Ç: ${test.title}`);
    console.log(`   –í–æ–ø—Ä–æ—Å–æ–≤: ${test.questions.length}\n`);

    console.log('üìù –°–æ–∑–¥–∞–µ–º –ª–µ–∫—Ü–∏—é...\n');

    const lecture = await prisma.lecture.create({
      data: {
        title: '–ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å HTTP –º–µ—Ç–æ–¥–æ–≤: –ü–æ–ª–Ω–æ–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ',
        topic: '–ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å',
        content: lectureContent,
      },
    });

    console.log(`‚úÖ –õ–µ–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∞ —Å ID: ${lecture.id}\n`);

    console.log('üîó –ü—Ä–∏–≤—è–∑—ã–≤–∞–µ–º –≤–æ–ø—Ä–æ—Å—ã –∫ –ª–µ–∫—Ü–∏–∏...\n');

    const questionIds = test.questions.map((tq) => tq.questionId);

    for (const questionId of questionIds) {
      await prisma.question.update({
        where: { id: questionId },
        data: { lectureId: lecture.id },
      });
    }

    console.log(`‚úÖ –ü—Ä–∏–≤—è–∑–∞–Ω–æ ${questionIds.length} –≤–æ–ø—Ä–æ—Å–æ–≤\n`);

    console.log('üéâ –ì–æ—Ç–æ–≤–æ!\n');
    console.log(
      `üìö –õ–µ–∫—Ü–∏—è "–ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å HTTP –º–µ—Ç–æ–¥–æ–≤: –ü–æ–ª–Ω–æ–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ" —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞ –∏ –ø—Ä–∏–≤—è–∑–∞–Ω–∞ –∫ —Ç–µ—Å—Ç—É "${test.title}"`
    );
  } catch (error) {
    console.error('‚ùå –û—à–∏–±–∫–∞:', error);
    throw error;
  } finally {
    await prisma.$disconnect();
  }
}

createLecture();
