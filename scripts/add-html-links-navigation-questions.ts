import { PrismaClient } from '@prisma/client';
import { PrismaPg } from '@prisma/adapter-pg';
import { Pool } from 'pg';
import dotenv from 'dotenv';
import path from 'path';

const envPath = path.resolve(__dirname, '..', '.env');
dotenv.config({ path: envPath });

const pool = new Pool({ connectionString: process.env.DATABASE_URL });
const adapter = new PrismaPg(pool);
const prisma = new PrismaClient({ adapter });

const lectureTitle = 'HTML: ссылки и навигация';
const legacyTitle = 'HTML: СЃСЃС‹Р»РєРё Рё РЅР°РІРёРіР°С†РёСЏ';

const questions = [
  {
    question: 'Что в лекции называется ссылкой, а что — навигацией?',
    options: [
      'Ссылка переносит к месту, навигация показывает структуру и путь по сайту.',
      'Ссылка показывает структуру, навигация запускает действия и формы на странице.',
      'Ссылка отвечает за безопасность, навигация — за скорость загрузки страниц.',
      'Ссылка хранит данные, навигация отправляет данные на сервер.'
    ],
    correctAnswer: 0,
    explanation:
      'В лекции сказано: ссылка переводит к месту, навигация помогает ориентироваться. ' +
      'Остальные варианты путают навигацию с действиями, стилями или данными.'
  },
  {
    question: 'Какую роль выполняет тег a по лекции?',
    options: [
      'Переводит пользователя к ресурсу или разделу внутри и вне сайта.',
      'Показывает структуру сайта и группирует меню в одном блоке.',
      'Группирует команды в контекстном меню с короткими действиями.',
      'Отправляет форму и выполняет действия вместо кнопки.'
    ],
    correctAnswer: 0,
    explanation:
      'Тег a используется для переходов к страницам, разделам и ресурсам. ' +
      'Структура сайта — это роль nav, а действия выполняет кнопка.'
  },
  {
    question: 'Что обязательно должно быть у ссылки по лекции?',
    options: [
      'Адрес href и понятный текст, который объясняет цель перехода.',
      'Роль button и стиль underline, чтобы напоминать кнопку пользователю.',
      'Атрибут rel и target, даже если ссылка ведет внутри сайта.',
      'Атрибут aria-label и title, даже когда текст видим.'
    ],
    correctAnswer: 0,
    explanation:
      'Лекция подчеркивает: у ссылки есть адрес и понятный текст. ' +
      'Rel, target, aria-label и title не обязательны в каждом случае.'
  },
  {
    question: 'Когда уместно использовать nav?',
    options: [
      'Когда нужно оформить меню, хлебные крошки и другие навигации.',
      'Когда нужно хранить данные формы и отправить их на сервер.',
      'Когда нужно вставить внешнюю ссылку внутри текста статьи.',
      'Когда нужно открыть документ в новой вкладке браузера.'
    ],
    correctAnswer: 0,
    explanation:
      'nav используется для навигационных блоков: меню, breadcrumbs, подвал. ' +
      'Формы и внешние ссылки не требуют nav.'
  },
  {
    question: 'Как в лекции объясняется menu?',
    options: [
      'Это боковая панель или контекстное меню, редкое, но полезно знать.',
      'Это обязательная замена nav для любого меню в шапке сайта.',
      'Это список ссылок только для футера и служебных разделов.',
      'Это инструмент для отправки данных форм на сервер.'
    ],
    correctAnswer: 0,
    explanation:
      'Лекция упоминает menu как боковую панель или контекстное меню. ' +
      'Остальные варианты приписывают menu роль nav или форм.'
  },
  {
    question: 'Когда использовать внутренние ссылки?',
    options: [
      'Когда переходите по разделам и страницам внутри своего сайта.',
      'Когда открываете внешний домен партнера или другой ресурс.',
      'Когда переходите к месту на той же странице через якорь.',
      'Когда запускаете письмо или звонок через mailto и tel.'
    ],
    correctAnswer: 0,
    explanation:
      'Внутренние ссылки ведут по страницам вашего сайта. ' +
      'Внешние, якорные и action-ссылки используются в других ситуациях.'
  },
  {
    question: 'Когда использовать внешние ссылки?',
    options: [
      'Когда переходите на другой домен или внешний ресурс.',
      'Когда открываете разделы текущего сайта по относительным путям.',
      'Когда переходите к месту на этой странице через id.',
      'Когда запускаете действия, например отправку формы.'
    ],
    correctAnswer: 0,
    explanation:
      'Внешние ссылки ведут за пределы сайта, на другой домен. ' +
      'Остальные варианты относятся к внутренним, якорным или action-ссылкам.'
  },
  {
    question: 'Что нужно для работы якорной ссылки?',
    options: [
      'Совпадение href с #id и id у целевой секции.',
      'Совпадение title ссылки и заголовка страницы.',
      'Совпадение классов ссылки и раздела страницы.',
      'Совпадение текста ссылки и названия раздела.'
    ],
    correctAnswer: 0,
    explanation:
      'Якорь работает, когда href указывает на #id и такой id есть у секции. ' +
      'Title, классы и текст не обеспечивают прокрутку.'
  },
  {
    question: 'Когда уместны ссылки на действия (mailto/tel/download)?',
    options: [
      'Когда реально нужно письмо, звонок или загрузка файла.',
      'Когда нужно перейти между разделами внутри сайта.',
      'Когда нужно открыть внешний сайт в новой вкладке.',
      'Когда нужно показать структуру сайта в меню.'
    ],
    correctAnswer: 0,
    explanation:
      'Action-ссылки используют только для реальных действий: письмо, звонок, загрузка. ' +
      'Для навигации по страницам они не подходят.'
  },
  {
    question: 'В чем разница относительного и абсолютного URL?',
    options: [
      'Относительный без домена для сайта, абсолютный с доменом для внешнего.',
      'Относительный всегда открывает новую вкладку, абсолютный — текущую.',
      'Относительный только для mailto, абсолютный — только для tel.',
      'Относительный всегда короче, абсолютный всегда использует якорь.'
    ],
    correctAnswer: 0,
    explanation:
      'Относительный URL не содержит домен и используется внутри сайта. ' +
      'Абсолютный URL включает домен и применяется для внешних ресурсов.'
  },
  {
    question: 'Что делает target _blank?',
    options: [
      'Открывает ссылку в новой вкладке браузера пользователя.',
      'Запрещает открытие ссылки для внешних доменов сайта.',
      'Преобразует ссылку в кнопку для отправки формы.',
      'Скрывает ссылку от поисковиков и пользователей.'
    ],
    correctAnswer: 0,
    explanation:
      'target _blank открывает ссылку в новой вкладке. ' +
      'Он не блокирует домены и не превращает ссылку в кнопку.'
  },
  {
    question: 'Зачем нужен rel при _blank по лекции?',
    options: [
      'Чтобы новая страница не управляла вкладкой и не видела источник.',
      'Чтобы ссылка открывалась быстрее и загружалась без задержек.',
      'Чтобы браузер автоматически добавил заголовок страницы.',
      'Чтобы ссылка стала внутренней и не покидала сайт.'
    ],
    correctAnswer: 0,
    explanation:
      'rel защищает от управления вкладкой и раскрытия источника перехода. ' +
      'Он не ускоряет загрузку и не превращает ссылку во внутреннюю.'
  },
  {
    question: 'Что лучше описывает разницу noopener и noreferrer?',
    options: [
      'noopener блокирует управление вкладкой, noreferrer скрывает источник перехода.',
      'noopener открывает вкладку, noreferrer отменяет переход и сохраняет страницу.',
      'noopener делает ссылку относительной, noreferrer — абсолютной для домена.',
      'noopener нужен для tel, noreferrer — для mailto и звонков.'
    ],
    correctAnswer: 0,
    explanation:
      'noopener блокирует доступ новой страницы к вкладке, а noreferrer скрывает referer. ' +
      'Остальные варианты не связаны с безопасностью открытия ссылок.'
  },
  {
    question: 'Когда использовать aria-label вместо title?',
    options: [
      'Когда у ссылки нет видимого текста, например только иконка.',
      'Когда ссылка ведет на внешний домен и нужен реферер.',
      'Когда ссылка всегда открывается в новой вкладке пользователя.',
      'Когда ссылка используется для загрузки файлов из каталога.'
    ],
    correctAnswer: 0,
    explanation:
      'aria-label нужен, когда текста нет и его должен прочитать скринридер. ' +
      'title — лишь подсказка и не заменяет доступный текст.'
  },
  {
    question: 'Что показывает aria-current="page"?',
    options: [
      'Активную страницу или текущий раздел в меню.',
      'Запрет индексации ссылки поисковыми системами сайта.',
      'Открытие ссылки в новой вкладке автоматически.',
      'Скрытие ссылки от клавиатуры и фокуса.'
    ],
    correctAnswer: 0,
    explanation:
      'aria-current отмечает активный пункт навигации. ' +
      'Он не влияет на индексацию, вкладки или видимость фокуса.'
  },
  {
    question: 'Зачем нужен видимый фокус у ссылок?',
    options: [
      'Чтобы пользователь видел позицию при навигации с клавиатуры.',
      'Чтобы ссылка скрывалась после клика и не мешала чтению.',
      'Чтобы ссылку открывать только в новой вкладке браузера.',
      'Чтобы сделать текст ссылки таким же как обычный текст.'
    ],
    correctAnswer: 0,
    explanation:
      'Фокус помогает ориентироваться при навигации с клавиатуры. ' +
      'Скрытие ссылок и отсутствие контраста ухудшают доступность.'
  },
  {
    question: 'Когда использовать button вместо a?',
    options: [
      'Когда выполняется действие: отправка формы или запуск модалки.',
      'Когда переходите по страницам или разделам внутри сайта.',
      'Когда обозначаете текущую страницу в меню навигации.',
      'Когда нужно открыть внешний сайт в новой вкладке.'
    ],
    correctAnswer: 0,
    explanation:
      'button предназначен для действий, а a — для переходов. ' +
      'Активные пункты и внешние переходы остаются ссылками.'
  },
  {
    question: 'Что допустимо вкладывать внутрь a по лекции?',
    options: [
      'Текст и блоки, но без вложенных интерактивных элементов.',
      'Любые элементы, включая button, input и другую ссылку.',
      'Только текст и span, без div и изображений.',
      'Только изображения, иначе ссылка считается невалидной.'
    ],
    correctAnswer: 0,
    explanation:
      'Ссылка может оборачивать inline и block элементы, но без интерактивных. ' +
      'Вложенные кнопки или ссылки считаются ошибкой разметки.'
  },
  {
    question: 'Какой текст ссылки считается хорошим?',
    options: [
      'Тарифы и цены — сразу понятно, куда ведет переход.',
      'Нажми сюда — коротко и всегда понятно пользователю.',
      'Кликни — удобно и быстрее, чем длинные описания.',
      'Вот здесь — универсально подходит для любых ссылок.'
    ],
    correctAnswer: 0,
    explanation:
      'Хороший анкор ясно объясняет цель перехода. ' +
      'Общие фразы вроде «Нажми сюда» не дают контекста.'
  },
  {
    question: 'Зачем нужны внутренние ссылки для SEO?',
    options: [
      'Помогают строить карту сайта и понять важные разделы.',
      'Скрывают страницы от роботов и уменьшают индексацию сайта.',
      'Ускоряют загрузку и уменьшают размер HTML страниц.',
      'Заменяют необходимость писать заголовки страниц.'
    ],
    correctAnswer: 0,
    explanation:
      'Внутренние ссылки помогают поисковикам понять структуру и важные разделы. ' +
      'Они не скрывают страницы и не заменяют заголовки.'
  },
  {
    question: 'Когда использовать rel="nofollow"?',
    options: [
      'Для рекламных и внешних ссылок, которым не доверяют.',
      'Для всех внутренних ссылок, чтобы избежать дубликатов.',
      'Для якорных ссылок, чтобы не прыгала страница.',
      'Для ссылок в меню, чтобы они не индексировались.'
    ],
    correctAnswer: 0,
    explanation:
      'nofollow используют для рекламных или недоверенных внешних ссылок. ' +
      'Внутренним ссылкам nofollow обычно только мешает.'
  },
  {
    question: 'Что означает href="#" как ошибка?',
    options: [
      'Ложная ссылка, вызывает прыжок и не ведет к разделу.',
      'Полный адрес, который всегда открывает внешнюю вкладку.',
      'Атрибут, который делает ссылку доступной для скринридера.',
      'Признак, что ссылка ведет на нужный раздел страницы.'
    ],
    correctAnswer: 0,
    explanation:
      'href="#" не указывает на реальный раздел и вызывает прыжок вверх. ' +
      'Это типичная ошибка, а не рабочий путь.'
  },
  {
    question: 'Как оформить меню по best practices?',
    options: [
      'Использовать nav и список ссылок для структуры.',
      'Использовать div и набор ссылок без списка.',
      'Использовать только button и обработчики клика.',
      'Использовать только menu вместо nav во всех случаях.'
    ],
    correctAnswer: 0,
    explanation:
      'Лекция рекомендует nav и список ссылок для доступной структуры. ' +
      'Div, кнопки или замена на menu не дают нужной семантики.'
  },
  {
    question: 'Зачем нужен aria-label при нескольких nav?',
    options: [
      'Чтобы различать навигационные блоки для скринридеров.',
      'Чтобы запретить индексацию ссылок в меню.',
      'Чтобы открыть ссылки в новой вкладке автоматически.',
      'Чтобы заменить текст ссылок на иконки в меню.'
    ],
    correctAnswer: 0,
    explanation:
      'aria-label помогает скринридерам различать несколько nav на странице. ' +
      'Он не отвечает за индексацию и не заменяет текст ссылок.'
  },
  {
    question: 'Для чего нужны breadcrumbs?',
    options: [
      'Показывают путь пользователя и место в структуре сайта.',
      'Полностью заменяют основное меню на всех страницах.',
      'Отправляют форму поиска и фильтры на сервер.',
      'Загружают скрипты и стили для навигации.'
    ],
    correctAnswer: 0,
    explanation:
      'Breadcrumbs показывают путь и контекст в структуре сайта. ' +
      'Они не заменяют меню и не связаны с формами или скриптами.'
  },
  {
    question: 'Зачем нужна ссылка «Перейти к содержанию»?',
    options: [
      'Быстро перейти к контенту, минуя длинное меню.',
      'Открыть отдельную вкладку со всеми разделами сайта.',
      'Заменить хлебные крошки в каталоге страниц.',
      'Скрыть навигацию от поисковых роботов.'
    ],
    correctAnswer: 0,
    explanation:
      'Skip-link ускоряет доступ к основному контенту, особенно с клавиатуры. ' +
      'Он не заменяет breadcrumbs и не прячет меню от поиска.'
  },
  {
    question: 'Какая ошибка связана с использованием a для действий?',
    options: [
      'Ссылка используется вместо кнопки, хотя нужно действие.',
      'Ссылка открывается внутри сайта по относительному пути.',
      'Ссылка ведет на внешний домен через полный адрес.',
      'Ссылка содержит понятный текст и правильный адрес.'
    ],
    correctAnswer: 0,
    explanation:
      'Ссылка предназначена для перехода, а действия выполняет кнопка. ' +
      'Остальные варианты описывают корректные ситуации для ссылок.'
  },
  {
    question: 'Что советует лекция про внешние ссылки?',
    options: [
      'Часто удобно открывать их в новой вкладке.',
      'Всегда открывать их в той же вкладке без исключений.',
      'Всегда делать их относительными без домена.',
      'Всегда ставить nofollow для любых внешних ссылок.'
    ],
    correctAnswer: 0,
    explanation:
      'В лекции сказано, что внешние ссылки часто открывают в новой вкладке. ' +
      'Это совет, а не жесткое правило, и не связано с nofollow.'
  },
  {
    question: 'Когда уместно использовать относительный URL внутри сайта?',
    options: [
      'Когда ссылка ведет на страницу вашего сайта без указания домена.',
      'Когда нужно открыть внешний ресурс в новой вкладке.',
      'Когда ссылка запускает письмо через mailto или звонок.',
      'Когда требуется скрыть адрес от поисковых роботов.'
    ],
    correctAnswer: 0,
    explanation:
      'Относительный URL подходит для внутренних переходов по сайту. ' +
      'Внешние переходы и action-ссылки решаются другими форматами.'
  },
  {
    question: 'Почему понятный текст ссылки важен для пользователя?',
    options: [
      'Пользователь сразу понимает цель перехода и не теряется.',
      'Это ускоряет загрузку страницы и уменьшает размер HTML.',
      'Это заменяет необходимость использовать навигационное меню.',
      'Это делает ссылку безопасной без дополнительных атрибутов.'
    ],
    correctAnswer: 0,
    explanation:
      'Понятный текст помогает пользователю быстро понять, куда ведет ссылка. ' +
      'Он не влияет на скорость, безопасность и не заменяет навигацию.'
  }
];

async function addHtmlLinksNavigationQuestions() {
  try {
    const lecture = await prisma.lecture.findFirst({
      where: { title: { in: [lectureTitle, legacyTitle] } }
    });

    if (!lecture) throw new Error('Лекция не найдена');

    const test = await prisma.test.findFirst({
      where: { title: { in: [lectureTitle, legacyTitle] } }
    });

    if (!test) throw new Error('Тест не найден');

    const removedLinks = await prisma.testQuestion.deleteMany({
      where: { testId: test.id }
    });

    const orphaned = await prisma.question.findMany({
      where: { lectureId: lecture.id, tests: { none: {} } },
      select: { id: true }
    });

    if (orphaned.length > 0) {
      await prisma.question.deleteMany({
        where: { id: { in: orphaned.map((item) => item.id) } }
      });
    }

    let nextOrder = 1;

    for (const q of questions) {
      const existing = await prisma.question.findFirst({
        where: { question: q.question }
      });

      let questionId: string;

      if (existing) {
        const updated = await prisma.question.update({
          where: { id: existing.id },
          data: {
            question: q.question,
            options: q.options,
            correctAnswer: q.correctAnswer,
            explanation: q.explanation,
            lectureId: lecture.id
          }
        });
        questionId = updated.id;
        console.log(`♻️  Обновлен: ${q.question}`);
      } else {
        const created = await prisma.question.create({
          data: {
            question: q.question,
            options: q.options,
            correctAnswer: q.correctAnswer,
            explanation: q.explanation,
            lectureId: lecture.id
          }
        });
        questionId = created.id;
        console.log(`✅ Создан: ${q.question}`);
      }

      await prisma.testQuestion.create({
        data: {
          testId: test.id,
          questionId,
          order: nextOrder++
        }
      });
    }

    console.log(`🧹 Удалено старых связей: ${removedLinks.count}`);
    console.log(`🧼 Удалено сиротских вопросов: ${orphaned.length}`);
    console.log(`🎉 Готово! Добавлено/обновлено: ${questions.length} вопросов`);
  } catch (error) {
    console.error('❌ Ошибка:', error);
  } finally {
    await prisma.$disconnect();
    await pool.end();
  }
}

addHtmlLinksNavigationQuestions();
