import { PrismaClient } from '@prisma/client';
import { PrismaPg } from '@prisma/adapter-pg';
import { Pool } from 'pg';
import dotenv from 'dotenv';
import path from 'path';

const envPath = path.resolve(__dirname, '..', '.env');
dotenv.config({ path: envPath });

const pool = new Pool({ connectionString: process.env.DATABASE_URL });
const adapter = new PrismaPg(pool);
const prisma = new PrismaClient({ adapter });

const lectureContent = `# HTML: ссылки и навигация

## Что такое ссылки и навигация?

**Ссылка** — элемент, который переносит пользователя в другое место: страницу, раздел, файл или внешний ресурс.  
**Навигация** — набор ссылок, который помогает ориентироваться на сайте.

### Простая аналогия 🧭

Ссылка — это **дверь**, а навигация — **карта** в торговом центре.  
Дверь переводит в нужную комнату, карта показывает, где вы и куда идти.

💡 Совет: хороший интерфейс — когда пользователь не думает «куда нажать».  
✅ Вывод: ссылки отвечают за переход, навигация — за ориентацию.

---

## 1. Ссылка (a) — переход к ресурсу 🔗

**Назначение:** перевести пользователя к нужному месту.  
**Аналогия:** как дверь с табличкой «куда ведёт».

**Пример:**
~~~html
<a href="/about">О компании</a>
~~~

**Характеристики:**
- ✅ У ссылки есть **адрес** (**href**).
- ✅ Текст ссылки должен быть **понятным**.
- ✅ Может вести на внутренние страницы, внешние сайты, файлы, якоря.

**Когда использовать:** для переходов по сайту и между ресурсами.

⚠️ Важно: без **href** это не ссылка, а просто текст без перехода.

---

## 2. Навигация (nav) — карта сайта 🧭

**Назначение:** показать структуру сайта и помочь пользователю ориентироваться.  
**Аналогия:** карта в торговом центре, где показаны основные зоны.

**Пример:**
~~~html
<nav aria-label="Основная навигация">
  <ul>
    <li><a href="/courses">Курсы</a></li>
    <li><a href="/blog">Блог</a></li>
  </ul>
</nav>
~~~

**Характеристики:**
- ✅ Обычно оформляется через **nav** и список ссылок.
- ✅ Может быть несколько **nav**: основное меню, подвал, breadcrumbs.
- ✅ Для нескольких **nav** используйте **aria-label**.

**Когда использовать:** для меню, хлебных крошек и других навигационных блоков.

✅ Вывод: **nav** показывает, что блок — навигация.

Также встречается **menu**:
- **menu** — боковая панель (например, «популярные статьи»).  
- **menu** — контекстное меню (редко, но полезно знать).

---

## 3. Виды ссылок и когда их использовать

### 3.1 Внутренние ссылки
**Назначение:** переход по страницам вашего сайта.  
**Пример:**
~~~html
<a href="/courses">Все курсы</a>
~~~
**Когда использовать:** для разделов и страниц внутри сайта.

✅ Вывод: внутренние ссылки помогают пользователю ориентироваться, а поисковику — понимать структуру.

### 3.2 Внешние ссылки
**Назначение:** переход на другой домен.  
**Пример:**
~~~html
<a href="https://developer.mozilla.org">Документация</a>
~~~
💡 Совет: внешние ссылки часто открывают в новой вкладке.

### 3.3 Якорные ссылки
**Назначение:** переход к месту на той же странице.  
**Аналогия:** закладка в книге.  
**Пример:**
~~~html
<a href="#pricing">К тарифам</a>
<section id="pricing">...</section>
~~~
✅ Вывод: якорь работает только при совпадении **href** и **id**.

### 3.4 Ссылки на действия
**Назначение:** открыть письмо, звонок или скачать файл.  
**Пример:**
~~~html
<a href="mailto:support@example.com">Написать в поддержку</a>
~~~
⚠️ Важно: такие ссылки используют **только там, где реально есть действие**, а не навигация.

---

## 4. URL: относительные и абсолютные

| Тип | Пример | Когда использовать |
| --- | ------ | ---------------- |
| Относительный | /pricing | внутри сайта |
| Абсолютный | https://site.com/pricing | внешние ссылки |

Аналогия: относительный путь — «поверни налево в коридоре», абсолютный — «полный почтовый адрес».  
✅ Вывод: внутри сайта чаще используют относительные пути.

---

## 5. Открытие в новой вкладке и безопасность 🔒

**Назначение:** открыть внешний ресурс, не теряя текущую страницу.

**Пример:**
~~~html
<a href="https://partner.com" target="_blank" rel="noopener noreferrer">
  Партнер
</a>
~~~

**Характеристики:**
- **_blank** открывает новую вкладку.
- **rel** не дает новой странице управлять вашей вкладкой и узнавать, откуда вы пришли.

### Разница **noopener** и **noreferrer**
- **noopener** не дает новой странице управлять вашей вкладкой.  
- **noreferrer** дополнительно скрывает, откуда вы пришли, и обычно включает noopener.

✅ Вывод: если важен реферер — используйте **noopener**; если не нужен — **noreferrer**.

---

## 6. Доступность ссылок (Accessibility)

### Понятный текст
❌ «Нажми сюда»  
✅ «Скачать чек-лист»

### **title** vs **aria-label**
**title** — подсказка при наведении и **не** гарантирует доступность.  
**aria-label** — текст для скринридера, когда **нет видимого текста** (иконка).

💡 Совет: если есть видимый текст — его достаточно; **aria-label** добавляйте только при необходимости.

### Активная ссылка
**aria-current="page"** показывает, где пользователь находится.

### Видимый фокус
Ссылки должны быть доступны с клавиатуры (Tab).

✅ Вывод: понятный текст + фокус = основа доступности.

---

## 7. Ссылка vs кнопка

| Что делает | Используем |
| ---------- | ---------- |
| Переход на другую страницу | **a** |
| Действие (отправить форму, открыть модалку) | **button** |

⚠️ Важно: ссылка не должна «отправлять», а кнопка не должна «вести».

---

## 8. Что можно вкладывать внутрь **a**

В HTML5 ссылка может оборачивать **inline и block‑элементы** (текст, **span**, **div**, **img**).  
Но нельзя вкладывать другие **интерактивные элементы**: **button**, **input**, **select**, **textarea** и другую **a**.

**Пример:**
~~~html
<a href="/course/uiux" class="card">
  <div class="title">UI/UX дизайн</div>
  <div class="meta">12 уроков</div>
</a>
~~~

💡 Совет: ссылка может быть «карточкой», но внутри не должно быть других кликабельных элементов.

---

## 9. SEO и ссылки

- Описательные анкоры помогают поиску.
- Внутренние ссылки строят карту сайта.
- **rel="nofollow"** используют для рекламы и внешних ссылок, которым не доверяют.

💡 Совет: не ставьте nofollow на свои страницы — это мешает индексации.

---

## Типичные ошибки

1) **href="#"** — ложная ссылка и прыжки страницы.  
2) Ссылка без текста — непонятна пользователю.  
3) **_blank** без **rel** — риск безопасности.  
4) Использование **a** для действий (например, отправка формы).  
5) Навигация из **div** вместо **nav** — теряется семантика.  
6) Текст «Нажми сюда» — слабый смысл.  
7) Нет **aria-label** при нескольких **nav**.

---

## Best Practices

- Ссылки всегда с **href**.
- Понятный текст: «Подробнее о тарифах», а не «клик».
- Меню = **nav** + список.
- **_blank** только при необходимости и с **rel**.
- Для активной страницы — **aria-current**.

✅ Вывод: навигация должна быть простой, безопасной и понятной.

---

## Заключение

Ссылка — это направление, навигация — это маршрут.  
Если маршрут понятен, пользователь не теряется.

### Ключевые мысли

🎯 **a** отвечает за переход  
🎯 **nav** показывает структуру  
🎯 Понятный текст = доступность и SEO  
🎯 Адрес + понятная «табличка» = хорошая ссылка

💪 Делайте навигацию дружелюбной — и пользователь всегда найдет путь.
`;
const scenariosContent = `## Популярные сценарии

### Сценарий 1: Внешняя ссылка без rel

❌ **Неправильно**: внешняя ссылка открывается в новой вкладке без rel.  
✅ **Правильно**: добавить noopener и noreferrer.

**До:**
~~~html
<a href="https://partner.com" target="_blank">Партнер</a>
~~~

**После:**
~~~html
<a href="https://partner.com" target="_blank" rel="noopener noreferrer">Партнер</a>
~~~

**Почему**: rel не дает новой странице управлять вашей вкладкой и узнавать, откуда вы пришли.

**Практический пример:**  
DOC-01: Все внешние ссылки с target="_blank" должны содержать rel="noopener noreferrer".

---

### Сценарий 2: Меню без nav

❌ **Неправильно**: меню оформлено как набор div.  
✅ **Правильно**: использовать nav и список.

**До:**
~~~html
<div class="menu">
  <a href="/courses">Курсы</a>
  <a href="/blog">Блог</a>
</div>
~~~

**После:**
~~~html
<nav aria-label="Основная навигация">
  <ul>
    <li><a href="/courses">Курсы</a></li>
    <li><a href="/blog">Блог</a></li>
  </ul>
</nav>
~~~

**Почему**: скринридеры ожидают nav как блок навигации.

**Практический пример:**  
REQ-02: Основное меню оформляется семантическим блоком навигации.

---

### Сценарий 3: «Нажми сюда»

❌ **Неправильно**: ссылки с текстом «кликни».  
✅ **Правильно**: описать цель.

**До:**
~~~html
<a href="/pricing">Нажми сюда</a>
~~~

**После:**
~~~html
<a href="/pricing">Тарифы и цены</a>
~~~

**Почему**: пользователь должен понимать, куда ведет ссылка.

**Практический пример:**  
DOC-03: Текст ссылок должен описывать цель перехода.

---

### Сценарий 4: Ссылка вместо кнопки

❌ **Неправильно**: ссылка «Отправить заявку».  
✅ **Правильно**: кнопка отправки формы.

**До:**
~~~html
<a href="/submit">Отправить заявку</a>
~~~

**После:**
~~~html
<button type="submit">Отправить заявку</button>
~~~

**Почему**: ссылка = навигация, кнопка = действие.

**Практический пример:**  
REQ-04: Все действия формы выполняются кнопками, а не ссылками.

---

### Сценарий 5: Отсутствие aria-label

❌ **Неправильно**: две навигации без обозначения.  
✅ **Правильно**: добавлен aria-label.

**До:**
~~~html
<nav>
  <a href="/courses">Курсы</a>
</nav>
<nav>
  <a href="/help">Помощь</a>
</nav>
~~~

**После:**
~~~html
<nav aria-label="Основная навигация">
  <a href="/courses">Курсы</a>
</nav>
<nav aria-label="Справка">
  <a href="/help">Помощь</a>
</nav>
~~~

**Почему**: это помогает различать блоки навигации.

**Практический пример:**  
DOC-05: Если nav больше одного — каждому задается aria-label.

---

### Сценарий 6: Якорь без id

❌ **Неправильно**: ссылка ведет на #pricing, но id нет.  
✅ **Правильно**: добавить id секции.

**До:**
~~~html
<a href="#pricing">К тарифам</a>
<section>...</section>
~~~

**После:**
~~~html
<a href="#pricing">К тарифам</a>
<section id="pricing">...</section>
~~~

**Почему**: якорная ссылка работает только при совпадении id.

**Практический пример:**  
REQ-06: Все якорные ссылки должны иметь цель с id.

---

### Сценарий 7: Nofollow на внутренних ссылках

❌ **Неправильно**: nofollow стоит на внутренних разделах.  
✅ **Правильно**: nofollow только для внешних рекламных ссылок.

**До:**
~~~html
<a href="/blog" rel="nofollow">Блог</a>
~~~

**После:**
~~~html
<a href="/blog">Блог</a>
~~~

**Почему**: nofollow мешает индексации внутренних страниц.

**Практический пример:**  
DOC-07: nofollow используется только для внешних ссылок партнеров.

---

### Сценарий 8: Нет ссылки «Пропустить к содержанию»

❌ **Неправильно**: длинное меню без skip link.  
✅ **Правильно**: добавить ссылку для пропуска.

**До:**
~~~html
<nav>
  <a href="/courses">Курсы</a>
  <a href="/blog">Блог</a>
</nav>
~~~

**После:**
~~~html
<a class="skip-link" href="#content">Перейти к содержанию</a>
<nav>
  <a href="/courses">Курсы</a>
  <a href="/blog">Блог</a>
</nav>
~~~

**Почему**: пользователям с клавиатурой и скринридером так проще.

**Практический пример:**  
REQ-08: В начале страницы должна быть ссылка «Перейти к содержанию».
`;

const tasksContent = `## Задания для практики 🧪

### Задание 1: Внутренняя навигация
> **Ситуация:** у сайта есть раздел «Блог».  
> **Что сделать:** добавить ссылку на /blog.  
> **Критерий:** ссылка ведет на внутренний раздел.

**Ответ:**  
~~~html
<a href="/blog">Блог</a>
~~~
**Объяснение:** внутренняя ссылка использует относительный путь.

---

### Задание 2: Внешняя ссылка с безопасностью
> **Ситуация:** есть ссылка на партнерский сайт, нужно открыть в новой вкладке.  
> **Что сделать:** оформить безопасно.  
> **Критерий:** есть target и rel.

**Ответ:**  
~~~html
<a href="https://partner.com" target="_blank" rel="noopener noreferrer">Партнер</a>
~~~
**Объяснение:** rel не дает новой странице управлять вашей вкладкой и узнавать, откуда вы пришли.

---

### Задание 3: Якорь на раздел
> **Ситуация:** в длинной странице есть блок «Тарифы».  
> **Что сделать:** создать якорную ссылку.  
> **Критерий:** ссылка и id совпадают.

**Ответ:**  
~~~html
<a href="#pricing">К тарифам</a>
<section id="pricing">...</section>
~~~
**Объяснение:** якорь работает только при совпадении href и id.

---

### Задание 4: Семантическое меню
> **Ситуация:** основное меню содержит «Главная» и «Контакты».  
> **Что сделать:** оформить меню семантически.  
> **Критерий:** используется nav и список.

**Ответ:**  
~~~html
<nav aria-label="Основная навигация">
  <ul>
    <li><a href="/">Главная</a></li>
    <li><a href="/contacts">Контакты</a></li>
  </ul>
</nav>
~~~
**Объяснение:** nav + список делают меню доступным и понятным.

---

### Задание 5: Breadcrumbs
> **Ситуация:** на странице товара нужно показать путь.  
> **Что сделать:** оформить хлебные крошки.  
> **Критерий:** читается путь «Каталог → Телефоны → iPhone».

**Ответ:**  
~~~html
<nav aria-label="Хлебные крошки">
  <a href="/catalog">Каталог</a> → 
  <a href="/catalog/phones">Телефоны</a> → 
  <span>iPhone</span>
</nav>
~~~
**Объяснение:** breadcrumb помогает пользователю понять местоположение.

---

### Задание 6: Ссылка на письмо
> **Ситуация:** нужно связаться с поддержкой.  
> **Что сделать:** создать mailto.  
> **Критерий:** ссылка открывает почту.

**Ответ:**  
~~~html
<a href="mailto:support@example.com">Написать в поддержку</a>
~~~
**Объяснение:** mailto запускает почтовый клиент.

---

### Задание 7: Ссылка vs кнопка
> **Ситуация:** есть действие «Отправить заявку».  
> **Что сделать:** выбрать правильный элемент.  
> **Критерий:** используется кнопка.

**Ответ:**  
~~~html
<button type="submit">Отправить заявку</button>
~~~
**Объяснение:** кнопка отвечает за действие, а ссылка — за переход.

---

### Задание 8: Активный пункт меню
> **Ситуация:** пользователь на странице «Блог».  
> **Что сделать:** отметить активную ссылку.  
> **Критерий:** есть aria-current="page".

**Ответ:**  
~~~html
<a href="/blog" aria-current="page">Блог</a>
~~~
**Объяснение:** aria-current сообщает скринридеру активный раздел.
`;

const exampleContent = `## Пример: требования к навигации сайта 📄

Разрабатывается условно такой сайт: платформа онлайн‑курсов.  
После всех митингов с бизнесом и постановки задачи нужно было решить проблему:  
пользователи терялись в каталоге и не понимали, где они находятся.

Ниже — фрагмент готового документа по навигации и ссылкам.

---

### Раздел: Навигация и ссылки

**Цель:** пользователь всегда понимает, где находится и куда ведет каждая ссылка.

**Требования:**
1) Основное меню размещается в шапке и содержит: «Курсы», «Блог», «О нас», «Контакты».  
2) Для навигации используется семантический блок nav.  
3) В каждой ссылке текст описывает цель (например, «Каталог курсов», а не «Кликни»).  
4) Внешние ссылки открываются в новой вкладке и имеют rel="noopener noreferrer".  
5) Для длинных страниц добавляется ссылка «Перейти к содержанию».  
6) В разделе курса отображаются хлебные крошки: «Каталог → Дизайн → UI/UX».  
7) Активный пункт меню помечается aria-current="page".

**Критерии приемки:**
- Пользователь может попасть в любой раздел максимум за 2 клика.  
- Пользователь видит, где находится, за счет breadcrumbs.  
- Все внешние ссылки безопасны и не ломают текущую страницу.

**Фрагмент реализации (пример кода):**
~~~html
<a class="skip-link" href="#content">Перейти к содержанию</a>
<nav aria-label="Основная навигация">
  <ul>
    <li><a href="/courses">Каталог курсов</a></li>
    <li><a href="/blog">Блог</a></li>
  </ul>
</nav>
<nav aria-label="Хлебные крошки">
  <a href="/catalog">Каталог</a> → <span>UI/UX</span>
</nav>
<a href="https://partner.com" target="_blank" rel="noopener noreferrer">Партнер</a>
~~~
`;

async function createHtmlLinksNavigationLecture() {
  try {
    const lectureTitle = 'HTML: ссылки и навигация';
    // Legacy mojibake title saved in DB before encoding fix.
    const legacyTitle = 'HTML: СЃСЃС‹Р»РєРё Рё РЅР°РІРёРіР°С†РёСЏ';
    console.log(`🔄 Обновление лекции "${lectureTitle}"...\n`);

    const existingLectures = await prisma.lecture.findMany({
      where: { title: { in: [lectureTitle, legacyTitle] } },
      orderBy: { createdAt: 'asc' }
    });

    let lecture;
    if (existingLectures.length > 0) {
      const [primary, ...duplicates] = existingLectures;
      lecture = await prisma.lecture.update({
        where: { id: primary.id },
        data: {
          title: lectureTitle,
          topic: 'HTML',
          content: lectureContent,
          scenariosContent,
          exampleContent,
          tasksContent
        }
      });

      if (duplicates.length > 0) {
        await prisma.lecture.deleteMany({
          where: { id: { in: duplicates.map((item) => item.id) } }
        });
      }
    } else {
      lecture = await prisma.lecture.create({
        data: {
          title: lectureTitle,
          topic: 'HTML',
          content: lectureContent,
          scenariosContent,
          exampleContent,
          tasksContent
        }
      });
    }

    const test = await prisma.test.findFirst({
      where: { title: { in: [lectureTitle, legacyTitle] } },
      include: { questions: true }
    });

    if (test) {
      for (const tq of test.questions) {
        await prisma.question.update({
          where: { id: tq.questionId },
          data: { lectureId: lecture.id }
        });
      }
      console.log(`✅ Привязано вопросов: ${test.questions.length}`);
    } else {
      console.log('⚠️ Тест не найден, вопросы не привязаны');
    }

    console.log(`✅ Лекция готова с ID: ${lecture.id}`);
  } catch (error) {
    console.error('❌ Ошибка:', error);
    throw error;
  } finally {
    await prisma.$disconnect();
    await pool.end();
  }
}

createHtmlLinksNavigationLecture();


