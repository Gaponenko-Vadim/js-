// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ENUM —Ç–∏–ø—ã
enum Difficulty {
  beginner
  intermediate
  advanced
}

enum TestMode {
  learning
  exam
}

enum PomodoroType {
  work
  short_break
  long_break
}

enum CollectionType {
  profession
  learning_path
  custom
}

model User {
  id                     String                     @id @default(cuid())
  email                  String                     @unique
  password               String
  name                   String?
  emailVerified          DateTime? // –î–∞—Ç–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è email (null = –Ω–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω)
  skipTasksWarning       Boolean                    @default(false)
  createdAt              DateTime                   @default(now())
  updatedAt              DateTime                   @updatedAt
  testResults            TestResult[]
  pomodoroSessions       PomodoroSession[]
  testLists              UserTestList[] // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ —Å–ø–∏—Å–∫–∏ —Ç–µ—Å—Ç–æ–≤
  combinedTestResults    CombinedTestResult[] // –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∫–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤
  taskProgress           LectureTaskProgress[]
  emailVerificationTokens EmailVerificationToken[] // –¢–æ–∫–µ–Ω—ã –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è email

  @@index([emailVerified])
}

model Category {
  id          String @id @default(cuid())
  name        String @unique // –ù–∞–ø—Ä–∏–º–µ—Ä: "REST API", "Requirements"
  slug        String @unique // –ù–∞–ø—Ä–∏–º–µ—Ä: "rest-api", "requirements"
  description String
  icon        String // –≠–º–æ–¥–∑–∏ –∏–∫–æ–Ω–∫–∞
  order       Int    @default(0) // –ü–æ—Ä—è–¥–æ–∫ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è

  // –ò–µ—Ä–∞—Ä—Ö–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–π (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
  parentId String?
  parent   Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id], onDelete: SetNull)
  children Category[] @relation("CategoryHierarchy")

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  // Many-to-Many —Å —Ç–µ—Å—Ç–∞–º–∏ —á–µ—Ä–µ–∑ CategoryTest
  tests CategoryTest[]

  @@index([slug])
  @@index([parentId])
  @@index([order])
}

model Test {
  id          String     @id @default(cuid())
  title       String
  description String
  difficulty  Difficulty // ENUM: beginner | intermediate | advanced
  tags        String[]   @default([]) // –ü—Ä–æ—Ñ–µ—Å—Å–∏–∏: system-analyst, qa-engineer, frontend, backend, fullstack

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  // Many-to-Many —Å–≤—è–∑–∏
  categories  CategoryTest[] // –°–≤—è–∑—å —Å –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏ —á–µ—Ä–µ–∑ junction table
  collections CollectionTest[] // –°–≤—è–∑—å —Å –∫–æ–ª–ª–µ–∫—Ü–∏—è–º–∏
  questions   TestQuestion[]
  results     TestResult[]
  userLists   UserTestListItem[] // –°–≤—è–∑—å —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–º–∏ —Å–ø–∏—Å–∫–∞–º–∏

  @@index([difficulty])
  @@index([title])
}

model Question {
  id            String         @id @default(cuid())
  question      String
  options       Json // Array of strings
  correctAnswer Int
  explanation   String
  lectureId     String? // –°–≤—è–∑—å —Å –ª–µ–∫—Ü–∏–µ–π (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
  lecture       Lecture?       @relation(fields: [lectureId], references: [id], onDelete: SetNull)
  createdAt     DateTime       @default(now())
  tests         TestQuestion[]

  @@index([lectureId])
}

model TestQuestion {
  id         String   @id @default(cuid())
  testId     String
  questionId String
  order      Int // –ü–æ—Ä—è–¥–æ–∫ –≤–æ–ø—Ä–æ—Å–∞ –≤ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º —Ç–µ—Å—Ç–µ
  test       Test     @relation(fields: [testId], references: [id], onDelete: Cascade)
  question   Question @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@unique([testId, questionId])
  @@index([testId, order])
}

model TestResult {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  testId      String
  test        Test     @relation(fields: [testId], references: [id], onDelete: Cascade)
  answers     Json
  score       Int
  mode        TestMode @default(exam) // ENUM: learning | exam
  completedAt DateTime @default(now())

  @@index([userId])
  @@index([testId])
  @@index([userId, completedAt])
  @@index([testId, score])
  @@index([userId, mode])
}

model PomodoroSession {
  id          String       @id @default(cuid())
  userId      String
  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  duration    Int
  type        PomodoroType // ENUM: work | short_break | long_break
  completedAt DateTime     @default(now())

  @@index([userId])
  @@index([userId, completedAt])
  @@index([type])
}

// –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è –∫–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤ (–∏–∑ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö —Å–ø–∏—Å–∫–æ–≤)
model CombinedTestResult {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  listName String // –ù–∞–∑–≤–∞–Ω–∏–µ —Å–ø–∏—Å–∫–∞
  testIds  String[] // –ú–∞—Å—Å–∏–≤ ID —Ç–µ—Å—Ç–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –≤—Ö–æ–¥–∏–ª–∏ –≤ –∫–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ—Å—Ç

  totalScore     Int // –û–±—â–∏–π –ø—Ä–æ—Ü–µ–Ω—Ç (0-100)
  totalQuestions Int // –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–æ–ø—Ä–æ—Å–æ–≤
  correctAnswers Int // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤

  // –î–µ—Ç–∞–ª—å–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ –∫–∞–∂–¥–æ–º—É —Ç–µ—Å—Ç—É
  testScores Json // { "testId": { "score": 85, "correct": 17, "total": 20, "title": "Test Name" } }

  completedAt DateTime @default(now())

  @@index([userId])
  @@index([completedAt])
  @@map("combined_test_results")
}

model Lecture {
  id               String                @id @default(cuid())
  title            String // –ù–∞–∑–≤–∞–Ω–∏–µ –ª–µ–∫—Ü–∏–∏
  topic            String // –¢–µ–º–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "HTTP –º–µ—Ç–æ–¥—ã –∏ –æ—Å–Ω–æ–≤—ã")
  content          String                @db.Text // –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –ª–µ–∫—Ü–∏–∏ (Markdown)
  scenariosContent String?               @db.Text // –°—Ü–µ–Ω–∞—Ä–∏–∏ (Markdown), –æ—Ç–¥–µ–ª—å–Ω–∞—è –≤–∫–ª–∞–¥–∫–∞
  exampleContent   String?               @db.Text // –ü—Ä–∏–º–µ—Ä (Markdown), –æ—Ç–¥–µ–ª—å–Ω–∞—è –≤–∫–ª–∞–¥–∫–∞
  tasksContent     String?               @db.Text // –ó–∞–¥–∞–Ω–∏—è (Markdown), –æ—Ç–¥–µ–ª—å–Ω–∞—è –≤–∫–ª–∞–¥–∫–∞
  createdAt        DateTime              @default(now())
  updatedAt        DateTime              @updatedAt
  questions        Question[] // –°–≤—è–∑–∞–Ω–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã
  taskProgress     LectureTaskProgress[]

  @@index([title])
  @@index([topic])
}

model LectureTaskProgress {
  id          String   @id @default(cuid())
  userId      String
  lectureId   String
  taskId      String
  completedAt DateTime @default(now())

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  lecture Lecture @relation(fields: [lectureId], references: [id], onDelete: Cascade)

  @@unique([userId, lectureId, taskId])
  @@index([userId])
  @@index([lectureId])
}

// ============================================================
// –ù–û–í–´–ï –ú–û–î–ï–õ–ò: Many-to-Many –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞
// ============================================================

// Junction table: Category ‚Üî Test (Many-to-Many)
model CategoryTest {
  id         String @id @default(cuid())
  categoryId String
  testId     String
  order      Int    @default(0) // –ü–æ—Ä—è–¥–æ–∫ —Ç–µ—Å—Ç–∞ –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏

  category Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  test     Test     @relation(fields: [testId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([categoryId, testId])
  @@index([categoryId, order])
  @@map("category_tests")
}

// –ö–æ–ª–ª–µ–∫—Ü–∏–∏ (–°–±–æ—Ä–Ω—ã–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã –æ–±—É—á–µ–Ω–∏—è)
model Collection {
  id          String @id @default(cuid())
  name        String @unique // "–í—Å—ë –¥–ª—è —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –∞–Ω–∞–ª–∏—Ç–∏–∫–∞"
  slug        String @unique // "system-analyst-full"
  description String
  icon        String // üìä

  // –¢–∏–ø –∫–æ–ª–ª–µ–∫—Ü–∏–∏
  type CollectionType @default(custom) // ENUM: profession | learning_path | custom

  // –¶–µ–ª–µ–≤–∞—è —Ä–æ–ª—å
  targetRole String? // "system-analyst", "qa-engineer", etc.

  // –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
  estimatedHours Int? // –ü—Ä–∏–º–µ—Ä–Ω–æ–µ –≤—Ä–µ–º—è –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è
  level          Difficulty? // ENUM: beginner | intermediate | advanced

  order       Int     @default(0)
  isPublished Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Many-to-Many —Å —Ç–µ—Å—Ç–∞–º–∏
  tests CollectionTest[]

  @@index([slug])
  @@index([type])
  @@index([targetRole])
}

// Junction table: Collection ‚Üî Test (Many-to-Many)
model CollectionTest {
  id           String  @id @default(cuid())
  collectionId String
  testId       String
  order        Int     @default(0) // –ü–æ—Ä—è–¥–æ–∫ –≤ –ø—Ä–æ–≥—Ä–∞–º–º–µ –æ–±—É—á–µ–Ω–∏—è
  isRequired   Boolean @default(true) // –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π –∏–ª–∏ –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π

  collection Collection @relation(fields: [collectionId], references: [id], onDelete: Cascade)
  test       Test       @relation(fields: [testId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([collectionId, testId])
  @@index([collectionId, order])
  @@map("collection_tests")
}

// ============================================================
// –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–¨–°–ö–ò–ï –°–ü–ò–°–ö–ò –¢–ï–°–¢–û–í
// ============================================================

// –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π —Å–ø–∏—Å–æ–∫ —Ç–µ—Å—Ç–æ–≤ (–∞–Ω–∞–ª–æ–≥ –ø–ª–µ–π–ª–∏—Å—Ç–∞)
model UserTestList {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  name        String // –ù–∞–∑–≤–∞–Ω–∏–µ —Å–ø–∏—Å–∫–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä: "–ü–æ–≤—Ç–æ—Ä–∏—Ç—å –ø–µ—Ä–µ–¥ —Å–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏–µ–º")
  description String? // –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ
  icon        String  @default("üìã") // –≠–º–æ–¥–∑–∏ –∏–∫–æ–Ω–∫–∞
  color       String  @default("#667eea") // –¶–≤–µ—Ç –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏

  isPublic Boolean @default(false) // –ú–æ–∂–Ω–æ –ª–∏ –¥–µ–ª–∏—Ç—å—Å—è —Å–ø–∏—Å–∫–æ–º

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Many-to-Many —Å —Ç–µ—Å—Ç–∞–º–∏
  items UserTestListItem[]

  @@index([userId])
  @@map("user_test_lists")
}

// Junction table: UserTestList ‚Üî Test (Many-to-Many)
model UserTestListItem {
  id     String @id @default(cuid())
  listId String
  testId String
  order  Int    @default(0) // –ü–æ—Ä—è–¥–æ–∫ —Ç–µ—Å—Ç–∞ –≤ —Å–ø–∏—Å–∫–µ

  list UserTestList @relation(fields: [listId], references: [id], onDelete: Cascade)
  test Test         @relation(fields: [testId], references: [id], onDelete: Cascade)

  addedAt DateTime @default(now())

  @@unique([listId, testId])
  @@index([listId, order])
  @@map("user_test_list_items")
}

// ============================================================
// EMAIL VERIFICATION
// ============================================================

// –¢–æ–∫–µ–Ω—ã –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è email –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
model EmailVerificationToken {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique // –£–Ω–∏–∫–∞–ª—å–Ω—ã–π —Ç–æ–∫–µ–Ω –¥–ª—è —Å—Å—ã–ª–∫–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
  expiresAt DateTime // –°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è —Ç–æ–∫–µ–Ω–∞ (24 —á–∞—Å–∞)
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
  @@map("email_verification_tokens")
}
