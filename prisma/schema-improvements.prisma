// ============================================================
// –£–õ–£–ß–®–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø SCHEMA.PRISMA
// ============================================================
// –≠—Ç–æ—Ç —Ñ–∞–π–ª —Å–æ–¥–µ—Ä–∂–∏—Ç –ø—Ä–µ–¥–ª–∞–≥–∞–µ–º—ã–µ —É–ª—É—á—à–µ–Ω–∏—è –¥–ª—è —Ç–µ–∫—É—â–µ–π —Å—Ö–µ–º—ã
// –ù–ï –ó–ê–ú–ï–ù–Ø–¢–¨ schema.prisma –Ω–∞–ø—Ä—è–º—É—é!
// –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–∞–∫ reference –¥–ª—è –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω—ã—Ö –º–∏–≥—Ä–∞—Ü–∏–π
// ============================================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================================
// ENUMS (–Ω–æ–≤—ã–µ)
// ============================================================

enum Difficulty {
  BEGINNER
  INTERMEDIATE
  ADVANCED
}

enum TestMode {
  LEARNING
  EXAM
}

enum CollectionType {
  PROFESSION
  LEARNING_PATH
  CUSTOM
}

enum PomodoroType {
  WORK
  SHORT_BREAK
  LONG_BREAK
}

// ============================================================
// CORE MODELS
// ============================================================

model User {
  id                     String                  @id @default(cuid())
  email                  String                  @unique
  password               String
  name                   String?
  skipTasksWarning       Boolean                 @default(false)

  // Soft delete
  deletedAt              DateTime?

  createdAt              DateTime                @default(now())
  updatedAt              DateTime                @updatedAt

  testResults            TestResult[]
  pomodoroSessions       PomodoroSession[]
  testLists              UserTestList[]
  combinedTestResults    CombinedTestResult[]
  taskProgress           LectureTaskProgress[]

  @@index([email])
  @@index([deletedAt])
}

model Category {
  id          String         @id @default(cuid())
  name        String         @unique
  slug        String         @unique
  description String
  icon        String
  order       Int            @default(0)

  // –ò–µ—Ä–∞—Ä—Ö–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–π
  parentId    String?
  parent      Category?      @relation("CategoryHierarchy", fields: [parentId], references: [id], onDelete: SetNull)
  children    Category[]     @relation("CategoryHierarchy")

  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  tests       CategoryTest[]

  @@index([slug])
  @@index([parentId])
  @@index([order])  // –ù–û–í–´–ô –∏–Ω–¥–µ–∫—Å
}

model Test {
  id          String         @id @default(cuid())
  title       String
  description String
  difficulty  Difficulty     // –ò–ó–ú–ï–ù–ï–ù–û: –±—ã–ª String, —Å—Ç–∞–ª enum

  tags        String[]       @default([])

  // –£–î–ê–õ–ï–ù–û: categoryId –ø–æ–ª–µ (–º–∏–≥—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞)
  // categoryId  String?     @map("category_id")

  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  categories  CategoryTest[]
  collections CollectionTest[]
  questions   TestQuestion[]
  results     TestResult[]
  userLists   UserTestListItem[]

  // –£–î–ê–õ–ï–ù–û: @@index([categoryId])
  @@index([difficulty])
  @@index([tags], type: Gin)  // –ù–û–í–´–ô GIN –∏–Ω–¥–µ–∫—Å –¥–ª—è array
  @@index([title])            // –ù–û–í–´–ô –∏–Ω–¥–µ–∫—Å –¥–ª—è –ø–æ–∏—Å–∫–∞
}

model Question {
  id            String         @id @default(cuid())
  question      String
  options       Json           // Array<string>: ["Option 1", "Option 2", ...]
  correctAnswer Int
  explanation   String

  lectureId     String?
  lecture       Lecture?       @relation(fields: [lectureId], references: [id], onDelete: SetNull)

  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt  // –ù–û–í–û–ï –ø–æ–ª–µ

  tests         TestQuestion[]

  @@index([lectureId])  // –ù–û–í–´–ô –∏–Ω–¥–µ–∫—Å
}

model TestQuestion {
  id         String   @id @default(cuid())
  testId     String
  questionId String
  order      Int

  test       Test     @relation(fields: [testId], references: [id], onDelete: Cascade)
  question   Question @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@unique([testId, questionId])
  @@index([testId, order])
}

model TestResult {
  id          String   @id @default(cuid())
  userId      String
  testId      String
  answers     Json     // Array<number>: [0, 2, 1, ...] –∏–Ω–¥–µ–∫—Å—ã –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤
  score       Int

  mode        TestMode @default(EXAM)  // –ù–û–í–û–ï –ø–æ–ª–µ

  // Soft delete
  deletedAt   DateTime?  // –ù–û–í–û–ï –ø–æ–ª–µ

  completedAt DateTime @default(now())
  updatedAt   DateTime @updatedAt  // –ù–û–í–û–ï –ø–æ–ª–µ

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  test        Test     @relation(fields: [testId], references: [id], onDelete: Cascade)

  @@index([userId])                    // –ù–û–í–´–ô –∏–Ω–¥–µ–∫—Å
  @@index([testId])                    // –ù–û–í–´–ô –∏–Ω–¥–µ–∫—Å
  @@index([userId, completedAt])       // –ù–û–í–´–ô –∫–æ–º–ø–æ–∑–∏—Ç–Ω—ã–π –∏–Ω–¥–µ–∫—Å
  @@index([testId, score])             // –ù–û–í–´–ô –∫–æ–º–ø–æ–∑–∏—Ç–Ω—ã–π –∏–Ω–¥–µ–∫—Å
  @@index([userId, mode])              // –ù–û–í–´–ô –∏–Ω–¥–µ–∫—Å –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ —Ä–µ–∂–∏–º—É
  @@index([deletedAt])                 // –ù–û–í–´–ô –∏–Ω–¥–µ–∫—Å –¥–ª—è soft delete
}

model PomodoroSession {
  id          String       @id @default(cuid())
  userId      String
  duration    Int
  type        PomodoroType // –ò–ó–ú–ï–ù–ï–ù–û: –±—ã–ª String, —Å—Ç–∞–ª enum

  createdAt   DateTime     @default(now())  // –ù–û–í–û–ï –ø–æ–ª–µ
  updatedAt   DateTime     @updatedAt       // –ù–û–í–û–ï –ø–æ–ª–µ
  completedAt DateTime     @default(now())

  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])                // –ù–û–í–´–ô –∏–Ω–¥–µ–∫—Å
  @@index([userId, completedAt])   // –ù–û–í–´–ô –∫–æ–º–ø–æ–∑–∏—Ç–Ω—ã–π –∏–Ω–¥–µ–∫—Å
  @@index([type])                  // –ù–û–í–´–ô –∏–Ω–¥–µ–∫—Å
}

model CombinedTestResult {
  id            String   @id @default(cuid())
  userId        String

  listName      String
  testIds       String[] // –ü–†–ò–ú–ï–ß–ê–ù–ò–ï: –†–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å junction table –¥–ª—è FK integrity

  totalScore    Int
  totalQuestions Int
  correctAnswers Int

  testScores    Json     // { [testId]: { score: number, correct: number, total: number, title: string } }

  completedAt   DateTime @default(now())

  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([completedAt])
  @@map("combined_test_results")
}

model Lecture {
  id               String     @id @default(cuid())
  title            String
  topic            String     @unique  // –ò–ó–ú–ï–ù–ï–ù–û: –¥–æ–±–∞–≤–ª–µ–Ω @unique constraint
  content          String     @db.Text

  scenariosContent String?    @db.Text
  exampleContent   String?    @db.Text
  tasksContent     String?    @db.Text

  createdAt        DateTime   @default(now())
  updatedAt        DateTime   @updatedAt

  questions        Question[]
  taskProgress     LectureTaskProgress[]
}

model LectureTaskProgress {
  id          String   @id @default(cuid())
  userId      String
  lectureId   String
  taskId      String   // –ü–†–ò–ú–ï–ß–ê–ù–ò–ï: –î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å —Ñ–æ—Ä–º–∞—Ç taskId

  completedAt DateTime @default(now())

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  lecture     Lecture  @relation(fields: [lectureId], references: [id], onDelete: Cascade)

  @@unique([userId, lectureId, taskId])
  @@index([userId])
  @@index([lectureId])
}

// ============================================================
// JUNCTION TABLES (Many-to-Many)
// ============================================================

model CategoryTest {
  id         String   @id @default(cuid())
  categoryId String
  testId     String
  order      Int      @default(0)

  category   Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  test       Test     @relation(fields: [testId], references: [id], onDelete: Cascade)

  createdAt  DateTime @default(now())

  @@unique([categoryId, testId])
  @@index([categoryId, order])
  @@map("category_tests")
}

model Collection {
  id             String         @id @default(cuid())
  name           String         @unique
  slug           String         @unique
  description    String
  icon           String

  type           CollectionType @default(CUSTOM)  // –ò–ó–ú–ï–ù–ï–ù–û: –±—ã–ª String, —Å—Ç–∞–ª enum
  targetRole     String?
  estimatedHours Int?
  level          Difficulty?    // –ò–ó–ú–ï–ù–ï–ù–û: –±—ã–ª String?, —Å—Ç–∞–ª Difficulty?

  order          Int            @default(0)
  isPublished    Boolean        @default(true)

  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  tests          CollectionTest[]

  @@index([slug])
  @@index([type])
  @@index([targetRole])
  @@index([isPublished])  // –ù–û–í–´–ô partial index (–≤ SQL)
}

model CollectionTest {
  id           String     @id @default(cuid())
  collectionId String
  testId       String
  order        Int        @default(0)
  isRequired   Boolean    @default(true)

  collection   Collection @relation(fields: [collectionId], references: [id], onDelete: Cascade)
  test         Test       @relation(fields: [testId], references: [id], onDelete: Cascade)

  createdAt    DateTime   @default(now())

  @@unique([collectionId, testId])
  @@index([collectionId, order])
  @@map("collection_tests")
}

// ============================================================
// USER TEST LISTS
// ============================================================

model UserTestList {
  id          String             @id @default(cuid())
  userId      String
  name        String
  description String?
  icon        String             @default("üìã")
  color       String             @default("#667eea")
  isPublic    Boolean            @default(false)

  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt

  user        User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  items       UserTestListItem[]

  @@index([userId])
  @@index([isPublic])  // –ù–û–í–´–ô partial index (–≤ SQL)
  @@map("user_test_lists")
}

model UserTestListItem {
  id         String       @id @default(cuid())
  listId     String
  testId     String
  order      Int          @default(0)

  list       UserTestList @relation(fields: [listId], references: [id], onDelete: Cascade)
  test       Test         @relation(fields: [testId], references: [id], onDelete: Cascade)

  addedAt    DateTime     @default(now())

  @@unique([listId, testId])
  @@index([listId, order])
  @@map("user_test_list_items")
}

// ============================================================
// –ú–ò–ì–†–ê–¶–ò–Ø: –®–∞–≥–∏ –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞ –æ—Ç —Ç–µ–∫—É—â–µ–π —Å—Ö–µ–º—ã
// ============================================================

/*
1. –°–æ–∑–¥–∞—Ç—å ENUM —Ç–∏–ø—ã:
   - CREATE TYPE "Difficulty" AS ENUM ('BEGINNER', 'INTERMEDIATE', 'ADVANCED');
   - CREATE TYPE "TestMode" AS ENUM ('LEARNING', 'EXAM');
   - CREATE TYPE "CollectionType" AS ENUM ('PROFESSION', 'LEARNING_PATH', 'CUSTOM');
   - CREATE TYPE "PomodoroType" AS ENUM ('WORK', 'SHORT_BREAK', 'LONG_BREAK');

2. –ú–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ:
   - UPDATE "Test" SET difficulty = 'BEGINNER' WHERE difficulty ILIKE 'beginner';
   - UPDATE "Test" SET difficulty = 'INTERMEDIATE' WHERE difficulty ILIKE 'intermediate';
   - UPDATE "Test" SET difficulty = 'ADVANCED' WHERE difficulty ILIKE 'advanced';

3. –ò–∑–º–µ–Ω–∏—Ç—å —Ç–∏–ø—ã –∫–æ–ª–æ–Ω–æ–∫:
   - ALTER TABLE "Test" ALTER COLUMN difficulty TYPE "Difficulty" USING difficulty::"Difficulty";

4. –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–µ –ø–æ–ª—è:
   - ALTER TABLE "TestResult" ADD COLUMN mode "TestMode" DEFAULT 'EXAM';
   - ALTER TABLE "Question" ADD COLUMN "updatedAt" TIMESTAMP(3) DEFAULT CURRENT_TIMESTAMP;

5. –î–æ–±–∞–≤–∏—Ç—å –∏–Ω–¥–µ–∫—Å—ã (—Å–º. database-improvements.sql)

6. –£–¥–∞–ª–∏—Ç—å deprecated –ø–æ–ª–µ:
   - ALTER TABLE "Test" DROP COLUMN category_id;

7. –ü—Ä–∏–º–µ–Ω–∏—Ç—å unique constraint:
   - ALTER TABLE "Lecture" ADD CONSTRAINT "Lecture_topic_key" UNIQUE (topic);

8. –û–±–Ω–æ–≤–∏—Ç—å Prisma Client:
   - npx prisma generate
*/
